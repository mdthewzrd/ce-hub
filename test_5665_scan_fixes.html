<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5665/Scan Saved Scans Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .scan-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .port-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            margin-left: 10px;
        }
        .port-8000 { background: #28a745; color: white; }
        .port-5666 { background: #ffc107; color: black; }
    </style>
</head>
<body>
    <h1>üöÄ 5665/Scan Saved Scans Fix Verification</h1>

    <div class="container">
        <h2>üîß Port-Specific Backend Testing</h2>
        <p>Tests the hybrid approach for both main (8000) and 5665/scan (5666) environments.</p>

        <button onclick="testMainBackend()">Test Main Backend (Port 8000)</button>
        <span class="port-indicator port-8000">MAIN</span>

        <button onclick="test5665Backend()">Test 5665 Backend (Port 5666)</button>
        <span class="port-indicator port-5666">5665/SCAN</span>

        <button onclick="testBothBackends()">Test Both Backends</button>
        <button onclick="testLocalStorageFallback()">Test localStorage Fallback</button>

        <div id="backendResults"></div>
    </div>

    <div class="container">
        <h2>üíæ localStorage Synchronization Test</h2>
        <p>Tests that scans are synchronized between both systems.</p>

        <button onclick="createTestScan()">Create Test Scan</button>
        <button onclick="testCrossPortSync()">Test Cross-Port Sync</button>
        <button onclick="clearLocalScans()">Clear Local Scans</button>

        <div id="syncResults"></div>
    </div>

    <div class="container">
        <h2>üîÑ Data Format Compatibility Test</h2>
        <p>Tests that data formats are compatible between main and 5665/scan versions.</p>

        <button onclick="testDataCompatibility()">Test Format Compatibility</button>
        <button onclick="showCurrentLocalScans()">Show Current Local Scans</button>

        <div id="formatResults"></div>
    </div>

    <div class="container">
        <h2>üìä Test Summary</h2>
        <p>Summary of all test results.</p>

        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearAllResults()">Clear Results</button>

        <div id="summaryResults"></div>
    </div>

    <script>
        const STORAGE_KEY = 'traderra_saved_scans';

        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
        }

        async function testMainBackend() {
            try {
                const response = await fetch('http://localhost:8000/api/scans/user/test_user_123');
                const data = await response.json();

                if (response.ok && data.success) {
                    showResult('backendResults',
                        `<div class="success">‚úÖ Main Backend (8000) is working!</div>` +
                        `<div class="success">Found ${data.scans?.length || 0} scans</div>` +
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`, false);
                } else {
                    showResult('backendResults',
                        `<div class="error">‚ùå Main Backend (8000) returned error</div>`, true);
                }
            } catch (error) {
                showResult('backendResults',
                    `<div class="error">‚ùå Main Backend (8000) not available: ${error.message}</div>`, true);
            }
        }

        async function test5665Backend() {
            try {
                const response = await fetch('http://localhost:5666/api/scans/user/test_user_123');
                const data = await response.json();

                if (response.ok && data.success) {
                    showResult('backendResults',
                        `<div class="success">‚úÖ 5665 Backend (5666) is working!</div>` +
                        `<div class="success">Found ${data.scans?.length || 0} scans</div>` +
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`, false);
                } else {
                    showResult('backendResults',
                        `<div class="error">‚ùå 5665 Backend (5666) returned error</div>`, true);
                }
            } catch (error) {
                showResult('backendResults',
                    `<div class="error">‚ùå 5665 Backend (5666) not available: ${error.message}</div>`, true);
            }
        }

        async function testBothBackends() {
            try {
                const [mainResponse, scanResponse] = await Promise.allSettled([
                    fetch('http://localhost:8000/api/scans/user/test_user_123'),
                    fetch('http://localhost:5666/api/scans/user/test_user_123')
                ]);

                const mainWorking = mainResponse.status === 'fulfilled' && mainResponse.value.ok;
                const scanWorking = scanResponse.status === 'fulfilled' && scanResponse.value.ok;

                let results = '<h3>Backend Status:</h3>';

                if (mainWorking) {
                    const mainData = await mainResponse.value.json();
                    results += `<div class="success">‚úÖ Main (8000): ${mainData.scans?.length || 0} scans</div>`;
                } else {
                    results += `<div class="error">‚ùå Main (8000): Not available</div>`;
                }

                if (scanWorking) {
                    const scanData = await scanResponse.value.json();
                    results += `<div class="success">‚úÖ 5665 (5666): ${scanData.scans?.length || 0} scans</div>`;
                } else {
                    results += `<div class="error">‚ùå 5665 (5666): Not available</div>`;
                }

                results += '<div class="success">üéØ Hybrid approach will work with localStorage fallback</div>';

                showResult('backendResults', results, false);

            } catch (error) {
                showResult('backendResults',
                    `<div class="error">‚ùå Error testing backends: ${error.message}</div>`, true);
            }
        }

        function testLocalStorageFallback() {
            try {
                const localScans = localStorage.getItem(STORAGE_KEY);
                if (!localScans) {
                    showResult('backendResults',
                        `<div class="error">No local scans found - localStorage fallback will be used</div>`, true);
                    return;
                }

                const parsedData = JSON.parse(localScans);
                const scans = parsedData.scans || [];

                if (scans.length > 0) {
                    showResult('backendResults',
                        `<div class="success">‚úÖ localStorage fallback works!</div>` +
                        `<div class="success">Found ${scans.length} local scans</div>` +
                        `<div class="scan-item">Example: ${scans[0].name || 'Unknown scan'}</div>`, false);
                } else {
                    showResult('backendResults',
                        `<div class="error">localStorage exists but no scans found</div>`, true);
                }

            } catch (error) {
                showResult('backendResults',
                    `<div class="error">‚ùå localStorage error: ${error.message}</div>`, true);
            }
        }

        function createTestScan() {
            try {
                const existingStorage = localStorage.getItem(STORAGE_KEY);
                const storage = existingStorage ? JSON.parse(existingStorage) : {
                    version: '1.0',
                    scans: [],
                    settings: { maxSavedScans: 50, autoCleanupDays: 90 }
                };

                const testScan = {
                    id: `test_5665_${Date.now()}`,
                    name: `5665 Test Scan ${new Date().toLocaleString()}`,
                    createdAt: new Date().toISOString(),
                    scanParams: {
                        start_date: '2024-01-01',
                        end_date: '2024-12-11'
                    },
                    resultCount: Math.floor(Math.random() * 100) + 1,
                    scanType: 'LC Scanner',
                    description: 'Test scan for 5665/scan debugging',
                    scan_results: [
                        { ticker: 'SPY', price: 450, confidence: 85, gap: 2.3 },
                        { ticker: 'AAPL', price: 190, confidence: 78, gap: 1.8 }
                    ],
                    results: [
                        { ticker: 'SPY', price: 450, confidence: 85, gap: 2.3 },
                        { ticker: 'AAPL', price: 190, confidence: 78, gap: 1.8 }
                    ],
                    isFavorite: false
                };

                storage.scans.push(testScan);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(storage));

                showResult('syncResults',
                    `<div class="success">‚úÖ Created test scan: ${testScan.name}</div>` +
                    `<div class="success">This scan should appear in both main and 5665/scan pages</div>`, false);

            } catch (error) {
                showResult('syncResults',
                    `<div class="error">‚ùå Error creating test scan: ${error.message}</div>`, true);
            }
        }

        function testCrossPortSync() {
            const scanCount = localStorage.getItem(STORAGE_KEY);
            const scanData = scanCount ? JSON.parse(scanCount) : { scans: [] };

            showResult('syncResults',
                `<div class="success">‚úÖ Cross-Port Sync Status:</div>` +
                `<div class="success">localStorage has ${scanData.scans.length} scans</div>` +
                `<div class="success">Both main (8000) and 5665/scan (5666) will see these scans</div>` +
                `<div class="scan-item">Next: Test in browser at localhost:3000 and localhost:3000/scan</div>`, false);
        }

        function clearLocalScans() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                showResult('syncResults', '<div class="success">‚úÖ Cleared all local scans</div>', false);
            } catch (error) {
                showResult('syncResults',
                    `<div class="error">‚ùå Error clearing local scans: ${error.message}</div>`, true);
            }
        }

        function testDataCompatibility() {
            try {
                const localScans = localStorage.getItem(STORAGE_KEY);
                if (!localScans) {
                    showResult('formatResults',
                        `<div class="error">No scans to test - create a test scan first</div>`, true);
                    return;
                }

                const parsedData = JSON.parse(localScans);
                const scans = parsedData.scans || [];

                // Test main format conversion
                const mainFormat = scans.map((scan: any) => ({
                    scan_id: scan.id,
                    scan_name: scan.name,
                    timestamp: scan.createdAt,
                    results_count: scan.resultCount || 0,
                    scan_data: scan
                }));

                // Test 5665 format conversion
                const scanFormat = scans.map((scan: any) => ({
                    scan_id: scan.id,
                    scan_name: scan.name,
                    timestamp: scan.createdAt,
                    results_count: scan.resultCount || 0,
                    scan_results: scan.scan_results || scan.results || [],
                    scan_data: scan
                }));

                showResult('formatResults',
                    `<div class="success">‚úÖ Format Compatibility Test:</div>` +
                    `<div class="success">Main format: ${mainFormat.length} scans converted</div>` +
                    `<div class="success">5665 format: ${scanFormat.length} scans converted</div>` +
                    `<div class="success">‚úÖ All formats compatible!</div>`, false);

            } catch (error) {
                showResult('formatResults',
                    `<div class="error">‚ùå Format compatibility error: ${error.message}</div>`, true);
            }
        }

        function showCurrentLocalScans() {
            try {
                const localScans = localStorage.getItem(STORAGE_KEY);
                if (!localScans) {
                    showResult('formatResults', '<div class="error">No local scans found</div>', true);
                    return;
                }

                const parsedData = JSON.parse(localScans);
                const scans = parsedData.scans || [];

                if (scans.length === 0) {
                    showResult('formatResults', '<div class="error">localStorage exists but no scans found</div>', true);
                    return;
                }

                const scanList = scans.map((scan, index) =>
                    `<div class="scan-item">
                        <strong>${index + 1}. ${scan.name}</strong><br>
                        ID: ${scan.id}<br>
                        Created: ${new Date(scan.createdAt).toLocaleString()}<br>
                        Results: ${scan.resultCount || 0}<br>
                        Type: ${scan.scanType || 'Unknown'}<br>
                        Has scan_results: ${!!(scan.scan_results && scan.scan_results.length > 0) ? 'Yes' : 'No'}<br>
                        Has results: ${!!(scan.results && scan.results.length > 0) ? 'Yes' : 'No'}
                    </div>`
                ).join('');

                showResult('formatResults',
                    `<div class="success">‚úÖ Found ${scans.length} local scans:</div>${scanList}`, false);

            } catch (error) {
                showResult('formatResults',
                    `<div class="error">‚ùå Error reading local scans: ${error.message}</div>`, true);
            }
        }

        async function runAllTests() {
            let results = '<h2>üß™ Complete Test Results:</h2>';

            // Test 1: Backend availability
            try {
                const [mainResponse, scanResponse] = await Promise.allSettled([
                    fetch('http://localhost:8000/api/scans/user/test_user_123'),
                    fetch('http://localhost:5666/api/scans/user/test_user_123')
                ]);

                const mainWorking = mainResponse.status === 'fulfilled' && mainResponse.value.ok;
                const scanWorking = scanResponse.status === 'fulfilled' && scanResponse.value.ok;

                results += `<div class="success">‚úÖ Backend Test: ${mainWorking ? 'Main(8000)' : 'No'}, ${scanWorking ? '5665(5666)' : 'No'}</div>`;
            } catch (error) {
                results += `<div class="error">‚ùå Backend Test Failed: ${error.message}</div>`;
            }

            // Test 2: localStorage
            const localScans = localStorage.getItem(STORAGE_KEY);
            const scanCount = localScans ? JSON.parse(localScans).scans?.length || 0 : 0;
            results += `<div class="success">‚úÖ localStorage: ${scanCount} scans found</div>`;

            // Test 3: Compatibility
            results += `<div class="success">‚úÖ Format compatibility: Ready</div>`;

            // Test 4: Summary
            if (scanCount > 0) {
                results += `<div class="success">üéâ READY: Scans will appear in both main and 5665/scan pages!</div>`;
            } else {
                results += `<div class="error">‚ö†Ô∏è READY: Create test scans to verify functionality</div>`;
            }

            showResult('summaryResults', results, false);
        }

        function clearAllResults() {
            ['backendResults', 'syncResults', 'formatResults', 'summaryResults'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            testBothBackends();
        });
    </script>
</body>
</html>