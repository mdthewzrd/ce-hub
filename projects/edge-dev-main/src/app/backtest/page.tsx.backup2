'use client'

import { useState, useEffect } from 'react';

// Global window interface for external function calls
declare global {
  interface Window {
    projects: any[];
    refreshProjects?: () => Promise<void>;
    backtestProjects?: any[];
    refreshBacktestProjects?: () => Promise<void>;
  }
}

import { useRouter } from 'next/navigation';
import { Brain, Play, TrendingUp, BarChart3, Settings, Target, Clock, Database, MessageCircle, ChevronUp, ChevronDown, RefreshCw, Save, X, Check, Wand2, Upload } from 'lucide-react';
import EdgeChart, { ChartData, Timeframe, CHART_TEMPLATES } from '@/components/EdgeChart';
import TradingViewToggle from '@/components/TradingViewToggle';
import { fetchPolygonData, calculateVWAP, calculateEMA, calculateATR, PolygonBar } from '@/utils/polygonData';
import RenataV2Chat from '@/components/renata/RenataV2Chat';
import { calculateTradingDayTarget, formatTradingDayOffset, getDayOfWeekName } from '@/utils/tradingDays';
import { fetchChartDataForDay } from '@/utils/chartDayNavigation';

// Types for backtest data
interface BacktestResult {
  id: string;
  name: string;
  description: string;
  created_at: string;
  status: 'completed' | 'running' | 'failed';
  equity_curve: number[];
  trades: Trade[];
  statistics: BacktestStatistics;
  parameters: BacktestParameters;
  execution_wedges?: ExecutionWedge[];
}

interface ExecutionWedge {
  type: 'buy' | 'sell';  // buy = green wedge (long entry/short exit), sell = red wedge (short exit/long entry)
  date: string;
  price: number;
  size: number;
  label: string;
  trade_id?: string;
}

interface Trade {
  id: string;
  ticker: string;
  entry_date: string;
  exit_date: string;
  entry_price: number;
  exit_price: number;
  quantity: number;
  pnl: number;
  r_multiple: number;
  type: 'long' | 'short';
}

interface BacktestStatistics {
  // Core Performance (15 metrics)
  total_return: number;
  cagr: number;
  max_drawdown: number;
  sharpe_ratio: number;
  sortino_ratio: number;
  calmar_ratio: number;
  win_rate: number;
  profit_factor: number;
  expectancy: number;
  avg_trade: number;
  avg_win: number;
  avg_loss: number;
  largest_win: number;
  largest_loss: number;

  // Trade Statistics (12 metrics)
  total_trades: number;
  winning_trades: number;
  losing_trades: number;
  avg_trade_duration: number;
  avg_win_duration: number;
  avg_loss_duration: number;
  best_trade: number;
  worst_trade: number;
  avg_r_multiple: number;
  expectancy_r_multiple: number;
  max_consecutive_wins: number;
  max_consecutive_losses: number;

  // Risk Metrics (10 metrics)
  volatility: number;
  var_95: number;
  cvar_95: number;
  avg_drawdown: number;
  avg_drawdown_duration: number;
  recovery_factor: number;

  // Validation Metrics (13 metrics)
  is_return: number;
  oos_return: number;
  walk_forward_avg: number;
  walk_forward_std: number;
  monte_carlo_5th: number;
  monte_carlo_95th: number;
}

interface BacktestParameters {
  initial_capital: number;
  risk_per_trade: number;
  stop_loss_atr_multiplier: number;
  profit_target_r: number;
  max_positions: number;
  pyramiding_enabled: boolean;
  pyramiding_entries: number;
  trailing_stop_enabled: boolean;
  trailing_stop_atr: number;
}

// Generate execution wedges from trades
function generateExecutionWedges(trades: Trade[]): ExecutionWedge[] {
  const wedges: ExecutionWedge[] = [];

  trades.forEach(trade => {
    // Entry wedge: GREEN for long entry, RED for short entry
    wedges.push({
      type: trade.type === 'long' ? 'buy' : 'sell',
      date: trade.entry_date,
      price: trade.entry_price,
      size: trade.quantity,
      label: 'ENTRY',
      trade_id: trade.id
    });

    // Exit wedge: RED for long exit (sell), GREEN for short exit (cover)
    wedges.push({
      type: trade.type === 'long' ? 'sell' : 'buy',
      date: trade.exit_date,
      price: trade.exit_price,
      size: trade.quantity,
      label: 'EXIT',
      trade_id: trade.id
    });
  });

  return wedges;
}

export default function BacktestPage() {
  const router = useRouter();

  // State management
  const [viewMode, setViewMode] = useState<'table' | 'chart'>('table');
  const [selectedTicker, setSelectedTicker] = useState<string>('SPY');
  const [selectedData, setSelectedData] = useState<{ chartData: ChartData } | null>(null);
  const [timeframe, setTimeframe] = useState<Timeframe>('daily');
  const [dayNavigation, setDayNavigation] = useState(0);
  const [isLoadingData, setIsLoadingData] = useState(false);

  // Backtest state
  const [backtestProjects, setBacktestProjects] = useState<BacktestResult[]>([]);
  const [selectedBacktest, setSelectedBacktest] = useState<BacktestResult | null>(null);
  const [selectedTradeId, setSelectedTradeId] = useState<string | null>(null);
  const [isRenataV2ModalOpen, setIsRenataV2ModalOpen] = useState(false);

  // Statistics tabs
  const [activeStatsTab, setActiveStatsTab] = useState<'core' | 'trades' | 'risk' | 'rmultiple' | 'validation' | 'comparison'>('core');

  // File upload state
  const [uploadedFile, setUploadedFile] = useState<File | null>(null);
  const [uploadedCode, setUploadedCode] = useState<string>('');
  const [isProcessingBacktest, setIsProcessingBacktest] = useState(false);

  // Date range state
  const [backtestStartDate, setBacktestStartDate] = useState(() => {
    const date = new Date();
    date.setDate(date.getDate() - 90); // Default: 90 days ago
    return date.toISOString().split('T')[0];
  });
  const [backtestEndDate, setBacktestEndDate] = useState(() => {
    return new Date().toISOString().split('T')[0]; // Default: today
  });

  // Load sample backtest data
  useEffect(() => {
    loadSampleBacktestData();
  }, []);

  // Load chart data when ticker selection changes
  useEffect(() => {
    if (selectedTicker) {
      loadChartData(selectedTicker, timeframe, dayNavigation);
    }
  }, [selectedTicker, timeframe, dayNavigation]);

  const loadSampleBacktestData = () => {
    // Sample backtest data for UI development
    const sampleBacktests: BacktestResult[] = [
      {
        id: '1',
        name: 'Mean Reversion Strategy',
        description: 'RSI oversold with Bollinger Band confirmation on tech stocks',
        created_at: '2024-01-15',
        status: 'completed',
        equity_curve: [100000, 101200, 102500, 101800, 103400, 104800, 104200, 105600, 106800, 107500],
        trades: [
          {
            id: '1',
            ticker: 'AAPL',
            entry_date: '2024-01-02',
            exit_date: '2024-01-08',
            entry_price: 185.50,
            exit_price: 188.20,
            quantity: 50,
            pnl: 135.00,
            r_multiple: 0.67,
            type: 'long'
          },
          {
            id: '2',
            ticker: 'MSFT',
            entry_date: '2024-01-05',
            exit_date: '2024-01-12',
            entry_price: 370.20,
            exit_price: 378.50,
            quantity: 25,
            pnl: 207.50,
            r_multiple: 1.12,
            type: 'long'
          },
          {
            id: '3',
            ticker: 'GOOGL',
            entry_date: '2024-01-10',
            exit_date: '2024-01-16',
            entry_price: 142.30,
            exit_price: 138.90,
            quantity: 70,
            pnl: -238.00,
            r_multiple: -0.89,
            type: 'long'
          }
        ],
        statistics: {
          // Core Performance
          total_return: 0.075,
          cagr: 0.082,
          max_drawdown: -0.089,
          sharpe_ratio: 1.23,
          sortino_ratio: 1.87,
          calmar_ratio: 0.92,
          win_rate: 0.58,
          profit_factor: 1.65,
          expectancy: 34.83,
          avg_trade: 34.83,
          avg_win: 171.25,
          avg_loss: -119.33,
          largest_win: 350.00,
          largest_loss: -238.00,

          // Trade Statistics
          total_trades: 50,
          winning_trades: 29,
          losing_trades: 21,
          avg_trade_duration: 3.4,
          avg_win_duration: 2.8,
          avg_loss_duration: 4.2,
          best_trade: 2.4,
          worst_trade: -1.8,
          avg_r_multiple: 0.45,
          expectancy_r_multiple: 0.23,
          max_consecutive_wins: 5,
          max_consecutive_losses: 3,

          // Risk Metrics
          volatility: 0.142,
          var_95: -0.0234,
          cvar_95: -0.0456,
          avg_drawdown: -0.034,
          avg_drawdown_duration: 4.2,
          recovery_factor: 1.84,

          // Validation Metrics
          is_return: 0.089,
          oos_return: 0.054,
          walk_forward_avg: 0.067,
          walk_forward_std: 0.012,
          monte_carlo_5th: -0.034,
          monte_carlo_95th: 0.123
        },
        parameters: {
          initial_capital: 100000,
          risk_per_trade: 0.01,
          stop_loss_atr_multiplier: 2.0,
          profit_target_r: 1.5,
          max_positions: 10,
          pyramiding_enabled: false,
          pyramiding_entries: 0,
          trailing_stop_enabled: false,
          trailing_stop_atr: 0
        },
        execution_wedges: []  // Will be populated below
      }
    ];

    // Generate execution wedges for the sample backtest
    sampleBacktests[0].execution_wedges = generateExecutionWedges(sampleBacktests[0].trades);

    setBacktestProjects(sampleBacktests);
    setSelectedBacktest(sampleBacktests[0]);
  };

  const loadChartData = async (symbol: string, tf: Timeframe, dayOffset: number = 0) => {
    setIsLoadingData(true);
    try {
      const template = CHART_TEMPLATES[tf];
      const baseTargetDate = new Date();
      const endDate = calculateTradingDayTarget(baseTargetDate, dayOffset);
      const startDate = new Date(endDate);
      startDate.setDate(startDate.getDate() - template.defaultDays);

      const { chartData, success } = await fetchChartDataForDay(symbol, endDate, tf, dayOffset);

      if (success && chartData && chartData.x.length > 0) {
        setSelectedData({ chartData });
      } else {
        console.error(`No data received for ${symbol}`);
        setSelectedData(null);
      }
    } catch (error) {
      console.error(`Error fetching chart data for ${symbol}:`, error);
      setSelectedData(null);
    } finally {
      setIsLoadingData(false);
    }
  };

  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      setUploadedFile(file);
      console.log('üìÅ File selected:', file.name);

      // Read file content
      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target?.result as string;
        setUploadedCode(content);
        console.log('‚úÖ File loaded:', content.length, 'characters');
        console.log('üìù Ready to run backtest!');
      };
      reader.readAsText(file);
    }
  };

  const runUploadedBacktest = async () => {
    if (!uploadedCode) {
      alert('Please upload a scanner file first!');
      return;
    }

    setIsProcessingBacktest(true);
    console.log('üöÄ Running backtest from uploaded code...');
    console.log(`üìÖ Date Range: ${backtestStartDate} to ${backtestEndDate}`);

    try {
      // For now, create a simple mock backtest from the uploaded code
      // In production, this would call the backend API to execute the Python code

      // Extract scanner name from code
      const nameMatch = uploadedCode.match(/SCANNER_NAME\s*=\s*["']([^"']+)["']/);
      const scannerName = nameMatch ? nameMatch[1] : 'Uploaded Strategy';

      console.log(`üìÇ Scanner: ${scannerName}`);
      console.log(`üìÑ Code: ${uploadedCode.split('\n').length} lines, ${uploadedCode.length} characters`);

      // Create a new backtest result
      const newBacktest: BacktestResult = {
        id: Date.now().toString(),
        name: scannerName,
        description: `Uploaded from ${uploadedFile?.name || 'scanner.py'}`,
        created_at: new Date().toISOString().split('T')[0],
        status: 'completed',
        equity_curve: [100000, 100500, 101200, 100800, 102100, 103400, 102900, 104200, 105100, 105800],
        trades: [
          {
            id: '1',
            ticker: 'SPY',
            entry_date: '2024-06-15T09:35:00',
            exit_date: '2024-06-15T10:20:00',
            entry_price: 452.30,
            exit_price: 453.80,
            quantity: 100,
            pnl: 150.00,
            r_multiple: 0.75,
            type: 'long'
          },
          {
            id: '2',
            ticker: 'SPY',
            entry_date: '2024-06-15T11:15:00',
            exit_date: '2024-06-15T11:45:00',
            entry_price: 454.10,
            exit_price: 452.60,
            quantity: 100,
            pnl: -150.00,
            r_multiple: -0.75,
            type: 'long'
          },
          {
            id: '3',
            ticker: 'SPY',
            entry_date: '2024-06-15T13:30:00',
            exit_date: '2024-06-15T14:10:00',
            entry_price: 451.90,
            exit_price: 453.40,
            quantity: 100,
            pnl: 150.00,
            r_multiple: 0.75,
            type: 'long'
          }
        ],
        statistics: {
          total_return: 0.058,
          cagr: 0.065,
          max_drawdown: -0.012,
          sharpe_ratio: 1.45,
          sortino_ratio: 2.01,
          calmar_ratio: 4.83,
          win_rate: 0.667,
          profit_factor: 2.0,
          expectancy: 50.0,
          avg_trade: 50.0,
          avg_win: 150.0,
          avg_loss: -150.0,
          largest_win: 150.0,
          largest_loss: -150.0,
          total_trades: 3,
          winning_trades: 2,
          losing_trades: 1,
          avg_trade_duration: 0.75,
          avg_win_duration: 0.6,
          avg_loss_duration: 0.5,
          best_trade: 0.75,
          worst_trade: -0.75,
          avg_r_multiple: 0.25,
          expectancy_r_multiple: 0.17,
          max_consecutive_wins: 2,
          max_consecutive_losses: 1,
          volatility: 0.08,
          var_95: -0.008,
          cvar_95: -0.01,
          avg_drawdown: -0.008,
          avg_drawdown_duration: 0.5,
          recovery_factor: 4.83,
          is_return: 0.07,
          oos_return: 0.045,
          walk_forward_avg: 0.058,
          walk_forward_std: 0.008,
          monte_carlo_5th: 0.02,
          monte_carlo_95th: 0.09
        },
        parameters: {
          initial_capital: 100000,
          risk_per_trade: 0.01,
          stop_loss_atr_multiplier: 2.0,
          profit_target_r: 1.5,
          max_positions: 10,
          pyramiding_enabled: false,
          pyramiding_entries: 0,
          trailing_stop_enabled: false,
          trailing_stop_atr: 0
        },
        execution_wedges: []
      };

      // Generate execution wedges
      newBacktest.execution_wedges = generateExecutionWedges(newBacktest.trades);

      // Add to backtest projects
      setBacktestProjects(prev => [newBacktest, ...prev]);
      setSelectedBacktest(newBacktest);

      // Select SPY ticker to show chart
      setSelectedTicker('SPY');

      // Close popup after successful upload
      setIsRenataV2ModalOpen(false);

      // Reset upload state
      setUploadedFile(null);
      setUploadedCode('');

      console.log('‚úÖ Backtest completed successfully!');
      alert(`‚úÖ Backtest "${scannerName}" executed successfully!\n\nGenerated 3 trades on SPY.\n\nTotal Return: 5.8%\nWin Rate: 66.7%`);

    } catch (error) {
      console.error('‚ùå Error running backtest:', error);
      alert('‚ùå Error running backtest. Please check the file format.');
    } finally {
      setIsProcessingBacktest(false);
    }
  };

  return (
    <div style={{ display: 'flex', minHeight: '100vh', backgroundColor: '#0a0a0a' }}>
      {/* Left Sidebar - Projects */}
      <div
        style={{
          width: '296px',
          flexShrink: 0,
          backgroundColor: '#111111',
          borderRight: '1px solid rgba(212, 175, 55, 0.2)',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden',
          position: 'fixed',
          left: 0,
          top: 0,
          bottom: 0,
          zIndex: 10
        }}
      >
        {/* edge.dev Header Section */}
        <div
          style={{
            padding: '20px 20px 12px 20px',
            backgroundColor: 'rgba(17, 17, 17, 0.95)',
            borderBottom: '1px solid rgba(212, 175, 55, 0.15)'
          }}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              flexShrink: 0
            }}>
              <Brain
                style={{
                  width: '24px',
                  height: '24px',
                  color: '#D4AF37',
                  filter: 'drop-shadow(0 2px 4px rgba(212, 175, 55, 0.3))'
                }}
              />
              <span style={{
                fontSize: '18px',
                fontWeight: '700',
                color: '#ffffff',
                letterSpacing: '0.8px'
              }}>
                Traderra
              </span>
            </div>
            <div style={{
              fontSize: '14px',
              fontWeight: '700',
              color: '#D4AF37',
              backgroundColor: 'rgba(212, 175, 55, 0.12)',
              padding: '6px 12px',
              borderRadius: '8px',
              border: '2px solid rgba(212, 175, 55, 0.4)',
              letterSpacing: '0.5px',
              backdropFilter: 'blur(4px)',
              whiteSpace: 'nowrap',
              flexShrink: 0
            }}>
              edge.dev
            </div>
          </div>
          <div
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
              padding: '10px 14px',
              background: 'rgba(212, 175, 55, 0.08)',
              border: '1px solid rgba(212, 175, 55, 0.2)',
              borderRadius: '8px'
            }}
          >
            <BarChart3 className="h-4 w-4" style={{ color: '#D4AF37' }} />
            <span style={{ color: '#ffffff', fontWeight: '500', fontSize: '13px' }}>Backtest Engine</span>
            <span style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '12px' }}>‚Ä¢</span>
            <span style={{ color: '#D4AF37', fontWeight: '600', fontSize: '13px' }}>Strategy Validation</span>
          </div>
        </div>

        {/* Enhanced Projects List */}
        <div
          style={{
            flex: 1,
            padding: '20px',
            overflowY: 'auto'
          }}
        >
          <div
            style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '16px',
              paddingBottom: '8px',
              borderBottom: '1px solid rgba(212, 175, 55, 0.2)'
            }}
          >
            <h3
              style={{
                fontSize: '12px',
                fontWeight: '700',
                color: '#D4AF37',
                letterSpacing: '1px',
                textTransform: 'uppercase',
                margin: 0
              }}
            >
              Backtest Projects
            </h3>
            <div style={{ display: 'flex', gap: '4px' }}>
              <button
                onClick={() => {
                  const saved = localStorage.getItem('edge_dev_backtest_projects');
                  if (saved) {
                    const parsed = JSON.parse(saved);
                    setBacktestProjects(parsed);
                    console.log('‚úÖ Loaded backtest projects from localStorage');
                  }
                }}
                style={{
                  background: 'rgba(34, 197, 94, 0.1)',
                  border: '1px solid rgba(34, 197, 94, 0.3)',
                  borderRadius: '6px',
                  padding: '4px',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
                onMouseEnter={(e) => {
                  const target = e.target as HTMLElement;
                  target.style.background = 'rgba(34, 197, 94, 0.2)';
                  target.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                }}
                onMouseLeave={(e) => {
                  const target = e.target as HTMLElement;
                  target.style.background = 'rgba(34, 197, 94, 0.1)';
                  target.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                }}
                title="Load saved projects"
              >
                <Upload size={12} style={{ color: '#22c55e' }} />
              </button>
              <button
                onClick={() => {
                  localStorage.setItem('edge_dev_backtest_projects', JSON.stringify(backtestProjects));
                  console.log('‚úÖ Saved backtest projects to localStorage');
                }}
                style={{
                  background: 'rgba(59, 130, 246, 0.1)',
                  border: '1px solid rgba(59, 130, 246, 0.3)',
                  borderRadius: '6px',
                  padding: '4px',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
                onMouseEnter={(e) => {
                  const target = e.target as HTMLElement;
                  target.style.background = 'rgba(59, 130, 246, 0.2)';
                  target.style.borderColor = 'rgba(59, 130, 246, 0.5)';
                }}
                onMouseLeave={(e) => {
                  const target = e.target as HTMLElement;
                  target.style.background = 'rgba(59, 130, 246, 0.1)';
                  target.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                }}
                title="Save projects locally"
              >
                <Save size={12} style={{ color: '#3b82f6' }} />
              </button>
              <button
                onClick={() => {
                  loadSampleBacktestData();
                  console.log('üîÑ Refreshed backtest projects');
                }}
                style={{
                  background: 'rgba(212, 175, 55, 0.1)',
                  border: '1px solid rgba(212, 175, 55, 0.3)',
                  borderRadius: '6px',
                  padding: '4px',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
                onMouseEnter={(e) => {
                  const target = e.target as HTMLElement;
                  target.style.background = 'rgba(212, 175, 55, 0.2)';
                  target.style.borderColor = 'rgba(212, 175, 55, 0.5)';
                }}
                onMouseLeave={(e) => {
                  const target = e.target as HTMLElement;
                  target.style.background = 'rgba(212, 175, 55, 0.1)';
                  target.style.borderColor = 'rgba(212, 175, 55, 0.3)';
                }}
                title="Refresh projects"
              >
                <RefreshCw size={12} style={{ color: '#D4AF37' }} />
              </button>
            </div>
          </div>

          {backtestProjects.map((backtest) => (
            <button
              key={backtest.id}
              onClick={() => setSelectedBacktest(backtest)}
              style={{
                width: '100%',
                padding: '12px',
                marginBottom: '8px',
                backgroundColor: selectedBacktest?.id === backtest.id
                  ? 'rgba(212, 175, 55, 0.15)'
                  : 'rgba(255, 255, 255, 0.05)',
                border: selectedBacktest?.id === backtest.id
                  ? '1px solid rgba(212, 175, 55, 0.4)'
                  : '1px solid rgba(255, 255, 255, 0.1)',
                borderRadius: '8px',
                color: '#ffffff',
                fontSize: '13px',
                fontWeight: '500',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                textAlign: 'left',
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
              }}
              onMouseEnter={(e) => {
                if (selectedBacktest?.id !== backtest.id) {
                  e.currentTarget.style.backgroundColor = 'rgba(255, 255, 255, 0.08)';
                  e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.15)';
                }
              }}
              onMouseLeave={(e) => {
                if (selectedBacktest?.id !== backtest.id) {
                  e.currentTarget.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                  e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                }
              }}
            >
              <BarChart3 className="h-4 w-4" style={{ color: '#D4AF37', flexShrink: 0 }} />
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{
                  whiteSpace: 'nowrap',
                  overflow: 'hidden',
                  textOverflow: 'ellipsis',
                  fontWeight: '600',
                  fontSize: '12px'
                }}>
                  {backtest.name}
                </div>
                <div style={{
                  fontSize: '10px',
                  color: 'rgba(255, 255, 255, 0.5)',
                  marginTop: '2px'
                }}>
                  {backtest.status === 'completed' ? '‚úì Completed' : 'Running...'}
                </div>
              </div>
            </button>
          ))}
        </div>

        {/* Renata AI Assistant Button - Bottom of Sidebar */}
        {!isRenataV2ModalOpen && (
          <div
            style={{
              padding: '16px 20px',
              borderTop: '1px solid rgba(212, 175, 55, 0.15)'
            }}
          >
            <button
              onClick={() => setIsRenataV2ModalOpen(true)}
              style={{
                width: '100%',
                display: 'flex',
                alignItems: 'center',
                gap: '12px',
                padding: '14px 18px',
                borderRadius: '10px',
                border: '1px solid rgba(255, 255, 255, 0.1)',
                background: 'rgba(255, 255, 255, 0.02)',
                backdropFilter: 'blur(10px)',
                transition: 'all 0.2s ease',
                cursor: 'pointer',
                outline: 'none'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = 'rgba(255, 255, 255, 0.05)';
                e.currentTarget.style.transform = 'translateY(-1px)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = 'rgba(255, 255, 255, 0.02)';
                e.currentTarget.style.transform = 'translateY(0px)';
              }}
            >
              {/* Icon Container */}
              <div
                style={{
                  width: '32px',
                  height: '32px',
                  borderRadius: '8px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  background: 'linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(212, 175, 55, 0.1) 100%)',
                  border: '1px solid rgba(212, 175, 55, 0.3)',
                  boxShadow: '0 2px 8px rgba(212, 175, 55, 0.15)',
                  transition: 'all 0.2s ease'
                }}
              >
                <Brain
                  style={{
                    width: '16px',
                    height: '16px',
                    color: '#D4AF37'
                  }}
                />
              </div>

              {/* Text Content */}
              <div style={{ flex: 1, textAlign: 'left' }}>
                <div
                  style={{
                    fontSize: '14px',
                    fontWeight: '600',
                    color: '#FFFFFF',
                    marginBottom: '2px'
                  }}
                >
                  Renata
                </div>
                <div
                  style={{
                    fontSize: '12px',
                    fontWeight: '400',
                    color: 'rgba(255, 255, 255, 0.6)'
                  }}
                >
                  AI Assistant
                </div>
              </div>

              {/* Arrow Icon */}
              <MessageCircle
                style={{
                  width: '18px',
                  height: '18px',
                  color: 'rgba(255, 255, 255, 0.4)',
                  transition: 'all 0.2s ease'
                }}
              />
            </button>
          </div>
        )}
      </div>

      {/* Main Content Area */}
      <div
        style={{
          flex: 1,
          marginLeft: '296px',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden'
        }}
      >
        {/* Header */}
        <header
          style={{
            backgroundColor: '#111111',
            borderBottom: '1px solid rgba(212, 175, 55, 0.2)',
            padding: '20px 24px'
          }}
        >
          <div className="flex items-center justify-between flex-wrap gap-4">
            <div className="flex items-center gap-8">
              <div className="flex items-center gap-4">
                <Brain
                  className="h-8 w-8"
                  style={{
                    color: '#D4AF37',
                    filter: 'drop-shadow(0 2px 4px rgba(212, 175, 55, 0.3))'
                  }}
                />
                <span
                  style={{
                    fontSize: '22px',
                    fontWeight: '700',
                    color: '#ffffff',
                    letterSpacing: '0.8px'
                  }}
                >
                  Traderra
                </span>
              </div>
              <div
                style={{
                  fontSize: '16px',
                  fontWeight: '700',
                  color: '#D4AF37',
                  backgroundColor: 'rgba(212, 175, 55, 0.12)',
                  padding: '8px 16px',
                  borderRadius: '8px',
                  border: '2px solid rgba(212, 175, 55, 0.4)',
                  letterSpacing: '0.5px'
                }}
              >
                edge.dev
              </div>
            </div>
            <div
              className="flex items-center gap-3 text-sm"
              style={{
                backgroundColor: 'rgba(212, 175, 55, 0.08)',
                border: '1px solid rgba(212, 175, 55, 0.2)',
                borderRadius: '8px',
                padding: '12px 16px'
              }}
            >
              <BarChart3 className="h-4 w-4" style={{ color: '#D4AF37' }} />
              <span style={{ color: '#ffffff', fontWeight: '500' }}>Backtest Engine</span>
              <span style={{ color: 'rgba(255, 255, 255, 0.5)' }}>‚Ä¢</span>
              <span style={{ color: '#D4AF37', fontWeight: '600' }}>Strategy Validation</span>
            </div>
          </div>

          {/* Controls Row */}
          <div
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '16px',
              marginTop: '16px',
              backgroundColor: 'rgba(17, 17, 17, 0.6)',
              padding: '16px 20px',
              borderRadius: '12px',
              border: '1px solid rgba(212, 175, 55, 0.15)'
            }}
          >
            <TradingViewToggle value={viewMode} onChange={setViewMode} />

            {/* View Code Button */}
            <button
              onClick={() => {
                if (uploadedCode) {
                  alert(`üìÑ Uploaded Scanner Code (${uploadedCode.split('\n').length} lines)\n\n${uploadedCode.substring(0, 500)}...`);
                } else {
                  alert('No code uploaded yet. Upload a scanner file via Renata popup first!');
                }
              }}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                padding: '10px 16px',
                backgroundColor: 'rgba(17, 17, 17, 0.8)',
                border: '1px solid rgba(212, 175, 55, 0.2)',
                borderRadius: '8px',
                color: '#D4AF37',
                fontSize: '13px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.backgroundColor = 'rgba(212, 175, 55, 0.1)';
                e.currentTarget.style.borderColor = 'rgba(212, 175, 55, 0.4)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.backgroundColor = 'rgba(17, 17, 17, 0.8)';
                e.currentTarget.style.borderColor = 'rgba(212, 175, 55, 0.2)';
              }}
              title="View current scanner code"
            >
              <Database className="h-4 w-4" />
              View Code
            </button>

            {/* Date Range Controls */}
            <div className="flex items-center gap-4 flex-wrap">
              {/* From Date */}
              <div
                className="flex items-center gap-2"
                style={{
                  background: 'rgba(17, 17, 17, 0.8)',
                  padding: '8px 12px',
                  borderRadius: '8px',
                  border: '1px solid rgba(212, 175, 55, 0.2)',
                  backdropFilter: 'blur(10px)'
                }}
              >
                <label
                  htmlFor="backtestStartDate"
                  style={{
                    fontSize: '11px',
                    fontWeight: '700',
                    color: '#D4AF37',
                    letterSpacing: '1px',
                    textTransform: 'uppercase'
                  }}
                >
                  From
                </label>
                <input
                  id="backtestStartDate"
                  type="date"
                  value={backtestStartDate}
                  onChange={(e) => setBacktestStartDate(e.target.value)}
                  style={{
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(212, 175, 55, 0.2)',
                    borderRadius: '6px',
                    padding: '6px 10px',
                    color: '#ffffff',
                    fontSize: '12px',
                    fontWeight: '600',
                    letterSpacing: '0.5px',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.borderColor = 'rgba(212, 175, 55, 0.4)';
                    e.currentTarget.style.boxShadow = '0 0 8px rgba(212, 175, 55, 0.2)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.borderColor = 'rgba(212, 175, 55, 0.2)';
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                />
              </div>

              {/* To Date */}
              <div
                className="flex items-center gap-2"
                style={{
                  background: 'rgba(17, 17, 17, 0.8)',
                  padding: '8px 12px',
                  borderRadius: '8px',
                  border: '1px solid rgba(212, 175, 55, 0.2)',
                  backdropFilter: 'blur(10px)'
                }}
              >
                <label
                  htmlFor="backtestEndDate"
                  style={{
                    fontSize: '11px',
                    fontWeight: '700',
                    color: '#D4AF37',
                    letterSpacing: '1px',
                    textTransform: 'uppercase'
                  }}
                >
                  To
                </label>
                <input
                  id="backtestEndDate"
                  type="date"
                  value={backtestEndDate}
                  onChange={(e) => setBacktestEndDate(e.target.value)}
                  style={{
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(212, 175, 55, 0.2)',
                    borderRadius: '6px',
                    padding: '6px 10px',
                    color: '#ffffff',
                    fontSize: '12px',
                    fontWeight: '600',
                    letterSpacing: '0.5px',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.borderColor = 'rgba(212, 175, 55, 0.4)';
                    e.currentTarget.style.boxShadow = '0 0 8px rgba(212, 175, 55, 0.2)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.borderColor = 'rgba(212, 175, 55, 0.2)';
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                />
              </div>
            </div>

            {/* Run Code Button */}
            <button
              onClick={runUploadedBacktest}
              disabled={!uploadedCode || isProcessingBacktest}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                padding: '10px 20px',
                background: isProcessingBacktest
                  ? 'rgba(212, 175, 55, 0.2)'
                  : 'linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(212, 175, 55, 0.1) 100%)',
                border: '1px solid rgba(212, 175, 55, 0.4)',
                borderRadius: '8px',
                color: '#D4AF37',
                fontSize: '13px',
                fontWeight: '700',
                cursor: uploadedCode && !isProcessingBacktest ? 'pointer' : 'not-allowed',
                opacity: (uploadedCode && !isProcessingBacktest) ? 1 : 0.5,
                transition: 'all 0.2s ease',
                letterSpacing: '0.5px'
              }}
              onMouseEnter={(e) => {
                if (uploadedCode && !isProcessingBacktest) {
                  e.currentTarget.style.transform = 'translateY(-1px)';
                  e.currentTarget.style.boxShadow = '0 4px 12px rgba(212, 175, 55, 0.3)';
                }
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = 'none';
              }}
              title={uploadedCode ? 'Execute backtest with uploaded code' : 'Upload a scanner file first'}
            >
              {isProcessingBacktest ? (
                <>
                  <div style={{
                    width: '14px',
                    height: '14px',
                    border: '2px solid rgba(212, 175, 55, 0.3)',
                    borderTop: '2px solid #D4AF37',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                  }} />
                  Running...
                </>
              ) : (
                <>
                  <Play className="h-4 w-4" />
                  Run Code
                </>
              )}
            </button>
          </div>
        </header>

        {/* Content Area */}
        <div style={{ flex: 1, overflowY: 'auto', padding: '20px' }}>
          {selectedBacktest && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
              {/* TABLE MODE: Split view with results and stats */}
              {viewMode === 'table' ? (
                <React.Fragment>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    {/* Backtest Results Panel */}
                    <div
                      style={{
                        backgroundColor: '#111111',
                        border: '1px solid rgba(212, 175, 55, 0.2)',
                        borderRadius: '12px',
                        padding: '20px',
                        minHeight: '400px'
                      }}
                    >
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        marginBottom: '16px',
                        paddingBottom: '12px',
                        borderBottom: '1px solid rgba(212, 175, 55, 0.2)'
                      }}>
                        <Target style={{ color: '#D4AF37', width: '20px', height: '20px', marginRight: '12px' }} />
                        <h3 style={{ color: '#D4AF37', fontSize: '16px', fontWeight: '700', margin: 0 }}>
                          Backtest Results
                        </h3>
                      </div>

                      {/* Trade List */}
                      <div style={{ overflowY: 'auto', maxHeight: '350px' }}>
                        <table style={{ width: '100%', fontSize: '12px' }}>
                          <thead>
                            <tr style={{ borderBottom: '1px solid rgba(212, 175, 55, 0.2)' }}>
                              <th style={{ padding: '8px', textAlign: 'left', color: '#D4AF37', fontWeight: '600' }}>Ticker</th>
                              <th style={{ padding: '8px', textAlign: 'left', color: '#D4AF37', fontWeight: '600' }}>Entry</th>
                              <th style={{ padding: '8px', textAlign: 'left', color: '#D4AF37', fontWeight: '600' }}>Exit</th>
                              <th style={{ padding: '8px', textAlign: 'right', color: '#D4AF37', fontWeight: '600' }}>P&L</th>
                              <th style={{ padding: '8px', textAlign: 'right', color: '#D4AF37', fontWeight: '600' }}>R</th>
                            </tr>
                          </thead>
                          <tbody>
                            {selectedBacktest.trades.map((trade) => (
                              <tr
                                key={trade.id}
                                style={{
                                  borderBottom: '1px solid rgba(255, 255, 255, 0.05)',
                                  cursor: 'pointer',
                                  backgroundColor: selectedTradeId === trade.id ? 'rgba(212, 175, 55, 0.2)' : 'transparent',
                                  borderLeft: selectedTradeId === trade.id ? '3px solid #D4AF37' : '3px solid transparent'
                                }}
                                onClick={() => {
                                  setSelectedTradeId(trade.id);
                                  setSelectedTicker(trade.ticker);
                                }}
                                onMouseEnter={(e) => {
                                  if (selectedTradeId !== trade.id) {
                                    e.currentTarget.style.backgroundColor = 'rgba(212, 175, 55, 0.1)';
                                  }
                                }}
                                onMouseLeave={(e) => {
                                  if (selectedTradeId !== trade.id) {
                                    e.currentTarget.style.backgroundColor = 'transparent';
                                  }
                                }}
                              >
                                <td style={{ padding: '10px 8px', color: '#ffffff', fontWeight: '600' }}>
                                  {trade.ticker}
                                </td>
                                <td style={{ padding: '10px 8px', color: 'rgba(255, 255, 255, 0.7)' }}>
                                  {trade.entry_date}
                                </td>
                                <td style={{ padding: '10px 8px', color: 'rgba(255, 255, 255, 0.7)' }}>
                                  {trade.exit_date}
                                </td>
                                <td style={{
                                  padding: '10px 8px',
                                  textAlign: 'right',
                                  color: trade.pnl >= 0 ? '#10b981' : '#ef4444',
                                  fontWeight: '600'
                                }}>
                                  ${trade.pnl.toFixed(2)}
                                </td>
                                <td style={{
                                  padding: '10px 8px',
                                  textAlign: 'right',
                                  color: trade.r_multiple >= 0 ? '#10b981' : '#ef4444',
                                  fontWeight: '600'
                                }}>
                                  {trade.r_multiple > 0 ? '+' : ''}{trade.r_multiple.toFixed(2)}R
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {/* Statistics Panel with Tabs */}
                    <div
                      style={{
                        backgroundColor: '#111111',
                        border: '1px solid rgba(212, 175, 55, 0.2)',
                        borderRadius: '12px',
                        padding: '20px',
                        minHeight: '400px'
                      }}
                    >
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        marginBottom: '16px',
                        paddingBottom: '12px',
                        borderBottom: '1px solid rgba(212, 175, 55, 0.2)'
                      }}>
                        <TrendingUp style={{ color: '#D4AF37', width: '20px', height: '20px', marginRight: '12px' }} />
                        <h3 style={{ color: '#D4AF37', fontSize: '16px', fontWeight: '700', margin: 0 }}>
                          Statistics
                        </h3>
                      </div>

                      {/* Stats Tabs */}
                      <div style={{ display: 'flex', gap: '8px', marginBottom: '16px', flexWrap: 'wrap' }}>
                        {[
                          { id: 'core', label: 'Core' },
                          { id: 'trades', label: 'Trades' },
                          { id: 'risk', label: 'Risk' },
                          { id: 'rmultiple', label: 'R-Mult' },
                          { id: 'validation', label: 'Validation' }
                        ].map((tab) => (
                          <button
                            key={tab.id}
                            onClick={() => setActiveStatsTab(tab.id as any)}
                            style={{
                              padding: '8px 16px',
                              backgroundColor: activeStatsTab === tab.id
                                ? 'rgba(212, 175, 55, 0.2)'
                                : 'rgba(255, 255, 255, 0.05)',
                              border: activeStatsTab === tab.id
                                ? '1px solid rgba(212, 175, 55, 0.4)'
                                : '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: '8px',
                              color: activeStatsTab === tab.id ? '#D4AF37' : '#ffffff',
                              fontSize: '12px',
                              fontWeight: '600',
                              cursor: 'pointer',
                              transition: 'all 0.2s ease'
                            }}
                          >
                            {tab.label}
                          </button>
                        ))}
                      </div>

                      {/* Stats Content */}
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px' }}>
                        {activeStatsTab === 'core' && (
                          <>
                            {[
                              { label: 'Total Return', value: `${(selectedBacktest.statistics.total_return * 100).toFixed(1)}%`, color: '#10b981' },
                              { label: 'CAGR', value: `${(selectedBacktest.statistics.cagr * 100).toFixed(1)}%`, color: '#D4AF37' },
                              { label: 'Max Drawdown', value: `${(selectedBacktest.statistics.max_drawdown * 100).toFixed(1)}%`, color: '#ef4444' },
                              { label: 'Sharpe Ratio', value: selectedBacktest.statistics.sharpe_ratio.toFixed(2), color: '#D4AF37' },
                              { label: 'Win Rate', value: `${(selectedBacktest.statistics.win_rate * 100).toFixed(0)}%`, color: '#10b981' },
                              { label: 'Profit Factor', value: selectedBacktest.statistics.profit_factor.toFixed(2), color: '#D4AF37' }
                            ].map((stat, i) => (
                              <div
                                key={i}
                                style={{
                                  backgroundColor: 'rgba(212, 175, 55, 0.1)',
                                  border: '1px solid rgba(212, 175, 55, 0.3)',
                                  borderRadius: '8px',
                                  padding: '12px'
                                }}
                              >
                                <div style={{ fontSize: '10px', color: '#D4AF37', fontWeight: '600', marginBottom: '4px' }}>
                                  {stat.label}
                                </div>
                                <div style={{ fontSize: '18px', color: stat.color, fontWeight: 'bold', fontFamily: 'monospace' }}>
                                  {stat.value}
                                </div>
                              </div>
                            ))}
                          </>
                        )}

                        {activeStatsTab === 'trades' && (
                          <>
                            {[
                              { label: 'Total Trades', value: selectedBacktest.statistics.total_trades, color: '#D4AF37' },
                              { label: 'Winning Trades', value: selectedBacktest.statistics.winning_trades, color: '#10b981' },
                              { label: 'Losing Trades', value: selectedBacktest.statistics.losing_trades, color: '#ef4444' },
                              { label: 'Avg Trade', value: `$${selectedBacktest.statistics.avg_trade.toFixed(0)}`, color: '#D4AF37' },
                              { label: 'Avg Win', value: `$${selectedBacktest.statistics.avg_win.toFixed(0)}`, color: '#10b981' },
                              { label: 'Avg Loss', value: `$${selectedBacktest.statistics.avg_loss.toFixed(0)}`, color: '#ef4444' }
                            ].map((stat, i) => (
                              <div
                                key={i}
                                style={{
                                  backgroundColor: 'rgba(212, 175, 55, 0.1)',
                                  border: '1px solid rgba(212, 175, 55, 0.3)',
                                  borderRadius: '8px',
                                  padding: '12px'
                                }}
                              >
                                <div style={{ fontSize: '10px', color: '#D4AF37', fontWeight: '600', marginBottom: '4px' }}>
                                  {stat.label}
                                </div>
                                <div style={{ fontSize: '18px', color: stat.color, fontWeight: 'bold', fontFamily: 'monospace' }}>
                                  {stat.value}
                                </div>
                              </div>
                            ))}
                          </>
                        )}

                        {activeStatsTab === 'risk' && (
                          <>
                            {[
                              { label: 'Volatility', value: `${(selectedBacktest.statistics.volatility * 100).toFixed(1)}%`, color: '#D4AF37' },
                              { label: 'VaR 95%', value: `${(selectedBacktest.statistics.var_95 * 100).toFixed(2)}%`, color: '#ef4444' },
                              { label: 'Recovery Factor', value: selectedBacktest.statistics.recovery_factor.toFixed(2), color: '#10b981' },
                              { label: 'Max Consec. Losses', value: selectedBacktest.statistics.max_consecutive_losses, color: '#ef4444' }
                            ].map((stat, i) => (
                              <div
                                key={i}
                                style={{
                                  backgroundColor: 'rgba(212, 175, 55, 0.1)',
                                  border: '1px solid rgba(212, 175, 55, 0.3)',
                                  borderRadius: '8px',
                                  padding: '12px'
                                }}
                              >
                                <div style={{ fontSize: '10px', color: '#D4AF37', fontWeight: '600', marginBottom: '4px' }}>
                                  {stat.label}
                                </div>
                                <div style={{ fontSize: '18px', color: stat.color, fontWeight: 'bold', fontFamily: 'monospace' }}>
                                  {stat.value}
                                </div>
                              </div>
                            ))}
                          </>
                        )}

                        {activeStatsTab === 'rmultiple' && (
                          <>
                            {[
                              { label: 'Avg R-Multiple', value: `${selectedBacktest.statistics.avg_r_multiple.toFixed(2)}R`, color: '#D4AF37' },
                              { label: 'Expectancy (R)', value: `${selectedBacktest.statistics.expectancy_r_multiple.toFixed(2)}R`, color: '#10b981' },
                              { label: 'Best Trade', value: `${selectedBacktest.statistics.best_trade.toFixed(1)}R`, color: '#10b981' },
                              { label: 'Worst Trade', value: `${selectedBacktest.statistics.worst_trade.toFixed(1)}R`, color: '#ef4444' }
                            ].map((stat, i) => (
                              <div
                                key={i}
                                style={{
                                  backgroundColor: 'rgba(212, 175, 55, 0.1)',
                                  border: '1px solid rgba(212, 175, 55, 0.3)',
                                  borderRadius: '8px',
                                  padding: '12px'
                                }}
                              >
                                <div style={{ fontSize: '10px', color: '#D4AF37', fontWeight: '600', marginBottom: '4px' }}>
                                  {stat.label}
                                </div>
                                <div style={{ fontSize: '18px', color: stat.color, fontWeight: 'bold', fontFamily: 'monospace' }}>
                                  {stat.value}
                                </div>
                              </div>
                            ))}
                          </>
                        )}

                        {activeStatsTab === 'validation' && (
                          <>
                            {[
                              { label: 'In-Sample Return', value: `${(selectedBacktest.statistics.is_return * 100).toFixed(1)}%`, color: '#D4AF37' },
                              { label: 'Out-of-Sample Return', value: `${(selectedBacktest.statistics.oos_return * 100).toFixed(1)}%`, color: '#10b981' },
                              { label: 'Walk-Forward Avg', value: `${(selectedBacktest.statistics.walk_forward_avg * 100).toFixed(1)}%`, color: '#D4AF37' },
                              { label: 'MC 95th %ile', value: `${(selectedBacktest.statistics.monte_carlo_95th * 100).toFixed(1)}%`, color: '#10b981' }
                            ].map((stat, i) => (
                              <div
                                key={i}
                                style={{
                                  backgroundColor: 'rgba(212, 175, 55, 0.1)',
                                  border: '1px solid rgba(212, 175, 55, 0.3)',
                                  borderRadius: '8px',
                                  padding: '12px'
                                }}
                              >
                                <div style={{ fontSize: '10px', color: '#D4AF37', fontWeight: '600', marginBottom: '4px' }}>
                                  {stat.label}
                                </div>
                                <div style={{ fontSize: '18px', color: stat.color, fontWeight: 'bold', fontFamily: 'monospace' }}>
                                  {stat.value}
                                </div>
                              </div>
                            ))}
                          </>
                        )}
                      </div>
                    </div>
                  </div>

                {/* Chart Section (Full Width at Bottom) */}
                <div
                    style={{
                    backgroundColor: '#111111',
                    border: '1px solid rgba(212, 175, 55, 0.2)',
                    borderRadius: '12px',
                    padding: '20px'
                  }}
                >
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    marginBottom: '16px',
                    paddingBottom: '12px',
                    borderBottom: '1px solid rgba(212, 175, 55, 0.2)'
                  }}>
                    <TrendingUp style={{ color: '#D4AF37', width: '20px', height: '20px', marginRight: '12px' }} />
                    <h3 style={{ color: '#D4AF37', fontSize: '16px', fontWeight: '700', margin: 0 }}>
                      Chart Analysis
                    </h3>
                  </div>
                  {isLoadingData ? (
                    <div style={{
                      height: '400px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      backgroundColor: 'rgba(17, 17, 17, 0.5)',
                      borderRadius: '12px'
                    }}>
                      <div className="text-center">
                        <div className="text-6xl mb-4 animate-pulse">üìà</div>
                        <div style={{ color: '#ffffff', fontSize: '16px', fontWeight: '500' }}>
                          Loading {selectedTicker} chart data...
                        </div>
                        <div style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '13px', marginTop: '8px' }}>
                          Fetching real market data from Polygon API
                        </div>
                      </div>
                    </div>
                  ) : selectedTicker ? (
                    <div style={{ width: '100%', overflow: 'hidden' }}>
                      <EdgeChart
                        symbol={selectedTicker}
                        timeframe={timeframe}
                        data={selectedData?.chartData || { x: [], open: [], high: [], low: [], close: [], volume: [] }}
                        onTimeframeChange={setTimeframe}
                        dayNavigation={dayNavigation}
                      />
                    </div>
                  ) : (
                    <div style={{
                      height: '400px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      backgroundColor: 'rgba(17, 17, 17, 0.5)',
                      borderRadius: '12px'
                    }}>
                      <div className="text-center">
                        <div className="text-6xl mb-4">üìä</div>
                        <div style={{ color: '#ffffff', fontSize: '16px', fontWeight: '500' }}>
                          Click on a trade to view its chart
                        </div>
                        <div style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '13px', marginTop: '8px' }}>
                          Select a ticker from the backtest results above
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                </React.Fragment>
              ) : (
                <React.Fragment>
                {/* CHART MODE: Large chart, stats below */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                  {/* Large Chart Section */}
                  <div
                    style={{
                      backgroundColor: '#111111',
                      border: '1px solid rgba(212, 175, 55, 0.2)',
                      borderRadius: '12px',
                      padding: '20px'
                    }}
                  >
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      marginBottom: '16px',
                      paddingBottom: '12px',
                      borderBottom: '1px solid rgba(212, 175, 55, 0.2)'
                    }}>
                      <TrendingUp style={{ color: '#D4AF37', width: '20px', height: '20px', marginRight: '12px' }} />
                      <h3 style={{ color: '#D4AF37', fontSize: '16px', fontWeight: '700', margin: 0 }}>
                        Equity Curve
                      </h3>
                    </div>
                    <div style={{
                      height: '400px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      backgroundColor: 'rgba(17, 17, 17, 0.5)',
                      borderRadius: '8px'
                    }}>
                      <div className="text-center">
                        <div className="text-6xl mb-4">üìà</div>
                        <div style={{ color: '#ffffff', fontSize: '16px', fontWeight: '500' }}>
                          Equity chart visualization coming soon
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Smaller Stats Section */}
                  <div
                    style={{
                      backgroundColor: '#111111',
                      border: '1px solid rgba(212, 175, 55, 0.2)',
                      borderRadius: '12px',
                      padding: '20px'
                    }}
                  >
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      marginBottom: '16px',
                      paddingBottom: '12px',
                      borderBottom: '1px solid rgba(212, 175, 55, 0.2)'
                    }}>
                      <TrendingUp style={{ color: '#D4AF37', width: '20px', height: '20px', marginRight: '12px' }} />
                      <h3 style={{ color: '#D4AF37', fontSize: '16px', fontWeight: '700', margin: 0 }}>
                        Key Statistics
                      </h3>
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px' }}>
                      {[
                        { label: 'Total Return', value: `${(selectedBacktest.statistics.total_return * 100).toFixed(1)}%`, color: '#10b981' },
                        { label: 'Max DD', value: `${(selectedBacktest.statistics.max_drawdown * 100).toFixed(1)}%`, color: '#ef4444' },
                        { label: 'Sharpe', value: selectedBacktest.statistics.sharpe_ratio.toFixed(2), color: '#D4AF37' },
                        { label: 'Win Rate', value: `${(selectedBacktest.statistics.win_rate * 100).toFixed(0)}%`, color: '#10b981' }
                      ].map((stat, i) => (
                        <div
                          key={i}
                          style={{
                            backgroundColor: 'rgba(212, 175, 55, 0.1)',
                            border: '1px solid rgba(212, 175, 55, 0.3)',
                            borderRadius: '8px',
                            padding: '12px'
                          }}
                        >
                          <div style={{ fontSize: '10px', color: '#D4AF37', fontWeight: '600', marginBottom: '4px' }}>
                            {stat.label}
                          </div>
                          <div style={{ fontSize: '16px', color: stat.color, fontWeight: 'bold', fontFamily: 'monospace' }}>
                            {stat.value}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Chart Section (Full Width at Bottom) */}
                <div
                  style={{
                    backgroundColor: '#111111',
                    border: '1px solid rgba(212, 175, 55, 0.2)',
                    borderRadius: '12px',
                    padding: '20px'
                  }}
                >
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    marginBottom: '16px',
                    paddingBottom: '12px',
                    borderBottom: '1px solid rgba(212, 175, 55, 0.2)'
                  }}>
                    <TrendingUp style={{ color: '#D4AF37', width: '20px', height: '20px', marginRight: '12px' }} />
                    <h3 style={{ color: '#D4AF37', fontSize: '16px', fontWeight: '700', margin: 0 }}>
                      Chart Analysis
                    </h3>
                  </div>
                  {isLoadingData ? (
                    <div style={{
                      height: '400px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      backgroundColor: 'rgba(17, 17, 17, 0.5)',
                      borderRadius: '12px'
                    }}>
                      <div className="text-center">
                        <div className="text-6xl mb-4 animate-pulse">üìà</div>
                        <div style={{ color: '#ffffff', fontSize: '16px', fontWeight: '500' }}>
                          Loading {selectedTicker} chart data...
                        </div>
                        <div style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '13px', marginTop: '8px' }}>
                          Fetching real market data from Polygon API
                        </div>
                      </div>
                    </div>
                  ) : selectedTicker ? (
                    <div style={{ width: '100%', overflow: 'hidden' }}>
                      <EdgeChart
                        symbol={selectedTicker}
                        timeframe={timeframe}
                        data={selectedData?.chartData || { x: [], open: [], high: [], low: [], close: [], volume: [] }}
                        onTimeframeChange={setTimeframe}
                        dayNavigation={dayNavigation}
                      />
                    </div>
                  ) : (
                    <div style={{
                      height: '400px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      backgroundColor: 'rgba(17, 17, 17, 0.5)',
                      borderRadius: '12px'
                    }}>
                      <div className="text-center">
                        <div className="text-6xl mb-4">üìä</div>
                        <div style={{ color: '#ffffff', fontSize: '16px', fontWeight: '500' }}>
                          Click on a trade to view its chart
                        </div>
                        <div style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '13px', marginTop: '8px' }}>
                          Select a ticker from the backtest results above
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                </React.Fragment>
              )}
          </div>
        </div>

      {/* Renata AI Assistant Panel - EDGEDEV BRANDED */}
      {isRenataV2ModalOpen && (
        <div
          style={{
            position: 'fixed',
            top: '0',
            left: '0',
            right: '0',
            bottom: '0',
            backgroundColor: 'rgba(0, 0, 0, 0.75)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: '9999',
            overflow: 'hidden'
          }}
        >
          {/* Header - Clean EdgeDev Style */}
          <div
            style={{
              padding: '20px',
              borderBottom: '1px solid rgba(212, 175, 55, 0.15)',
              background: 'linear-gradient(180deg, rgba(212, 175, 55, 0.08) 0%, transparent 100%)'
            }}
          >
                      height: '400px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      backgroundColor: 'rgba(17, 17, 17, 0.5)',
                      borderRadius: '12px'
                    }}>
                      <div className="text-center">
                        <div className="text-6xl mb-4 animate-pulse">üìà</div>
                        <div style={{ color: '#ffffff', fontSize: '16px', fontWeight: '500' }}>
                          Loading {selectedTicker} chart data...
                        </div>
                        <div style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '13px', marginTop: '8px' }}>
                          Fetching real market data from Polygon API
                        </div>
                      </div>
                    </div>
                  ) : selectedTicker ? (
                    <div style={{ width: '100%', overflow: 'hidden' }}>
                      <EdgeChart
                        symbol={selectedTicker}
                        timeframe={timeframe}
                        data={selectedData?.chartData || { x: [], open: [], high: [], low: [], close: [], volume: [] }}
                        onTimeframeChange={setTimeframe}
                        dayNavigation={dayNavigation}
                      />
                    </div>
                  ) : (
                    <div style={{
                      height: '400px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      backgroundColor: 'rgba(17, 17, 17, 0.5)',
                      borderRadius: '12px'
                    }}>
                      <div className="text-center">
                        <div className="text-6xl mb-4">üìä</div>
                        <div style={{ color: '#ffffff', fontSize: '16px', fontWeight: '500' }}>
                          Click on a ticker to view its chart
                        </div>
                        <div style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '13px', marginTop: '8px' }}>
                          Select a ticker from the backtest results
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Smaller Stats Section */}
                <div
                  style={{
                    backgroundColor: '#111111',
                    border: '1px solid rgba(212, 175, 55, 0.2)',
                    borderRadius: '12px',
                    padding: '20px'
                  }}
                >
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    marginBottom: '16px',
                    paddingBottom: '12px',
                    borderBottom: '1px solid rgba(212, 175, 55, 0.2)'
                  }}>
                    <BarChart3 style={{ color: '#D4AF37', width: '20px', height: '20px', marginRight: '12px' }} />
                    <h3 style={{ color: '#D4AF37', fontSize: '16px', fontWeight: '700', margin: 0 }}>
                      Performance Summary
                    </h3>
                  </div>
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                    gap: '12px'
                  }}>
                    {performanceStats.map((stat, i) => (
                      <div
                        key={i}
                        style={{
                          backgroundColor: 'rgba(212, 175, 55, 0.1)',
                          border: '1px solid rgba(212, 175, 55, 0.3)',
                          borderRadius: '8px',
                          padding: '12px'
                        }}
                      >
                        <div style={{ fontSize: '10px', color: '#D4AF37', fontWeight: '600', marginBottom: '4px' }}>
                          {stat.label}
                        </div>
                        <div style={{ fontSize: '16px', color: stat.color, fontWeight: 'bold', fontFamily: 'monospace' }}>
                          {stat.value}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
                </React.Fragment>
              )}
          </div>
        </div>

      {/* Renata AI Assistant Panel - EDGEDEV BRANDED */}
      {isRenataV2ModalOpen && (
        <div
          style={{
            position: 'fixed',
            bottom: '24px',
            left: '24px',
            width: '420px',
            height: '640px',
            background: '#111111',
            borderRadius: '12px',
            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(212, 175, 55, 0.1)',
            display: 'flex',
            flexDirection: 'column',
            zIndex: 9999,
            border: '1px solid rgba(212, 175, 55, 0.2)',
            overflow: 'hidden'
          }}
        >
          {/* Header - Clean EdgeDev Style */}
          <div
            style={{
              padding: '20px',
              borderBottom: '1px solid rgba(212, 175, 55, 0.15)',
              background: 'linear-gradient(180deg, rgba(212, 175, 55, 0.08) 0%, transparent 100%)'
            }}
          >
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '14px' }}>
                {/* Brain Icon - Subtle */}
                <div
                  style={{
                    width: '44px',
                    height: '44px',
                    borderRadius: '12px',
                    background: 'linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.05) 100%)',
                    border: '1px solid rgba(212, 175, 55, 0.25)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    position: 'relative'
                  }}
                >
                  <Brain style={{ width: '22px', height: '22px', color: '#D4AF37' }} />
                  {/* Status Dot */}
                  <div
                    style={{
                      position: 'absolute',
                      top: '-2px',
                      right: '-2px',
                      width: '12px',
                      height: '12px',
                      background: '#10B981',
                      border: '2px solid #111111',
                      borderRadius: '50%',
                      boxShadow: '0 0 8px rgba(16, 185, 129, 0.6)'
                    }}
                  ></div>
                </div>

                {/* Title */}
                <div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <h3 style={{
                      color: '#D4AF37',
                      fontSize: '18px',
                      fontWeight: '700',
                      margin: 0,
                      letterSpacing: '0.3px'
                    }}>
                      Renata AI
                    </h3>
                    <div style={{
                      padding: '2px 8px',
                      background: 'rgba(212, 175, 55, 0.1)',
                      border: '1px solid rgba(212, 175, 55, 0.2)',
                      borderRadius: '4px',
                      fontSize: '11px',
                      fontWeight: '600',
                      color: '#D4AF37',
                      letterSpacing: '0.5px',
                      textTransform: 'uppercase'
                    }}>
                      V2
                    </div>
                  </div>
                  <p style={{
                    color: 'rgba(255, 255, 255, 0.5)',
                    fontSize: '13px',
                    margin: '2px 0 0 0',
                    fontWeight: '500'
                  }}>
                    Code Transformation
                  </p>
                </div>
              </div>

              {/* Close Button - Clean */}
              <button
                onClick={() => setIsRenataV2ModalOpen(false)}
                style={{
                  width: '36px',
                  height: '36px',
                  background: 'rgba(255, 255, 255, 0.03)',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: '10px',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = 'rgba(239, 68, 68, 0.15)';
                  e.currentTarget.style.borderColor = 'rgba(239, 68, 68, 0.25)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.03)';
                  e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.08)';
                }}
              >
                <X style={{ width: '18px', height: '18px', color: 'rgba(255, 255, 255, 0.6)' }} />
              </button>
            </div>
          </div>

          {/* Content Area */}
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', background: '#0a0a0a' }}>
            <RenataV2Chat />
          </div>
        </div>
      )}
    </div>
  );
}

// Add global styles for spinner animation
if (typeof document !== 'undefined') {
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
}

