name: Edge.dev Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/pw-browsers

jobs:
  # Smoke tests - quick validation
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Playwright
      run: |
        npm run test:install
        npm run test:install-deps

    - name: Build application
      run: npm run build

    - name: Run smoke tests
      run: npm run test:smoke
      env:
        CI: true

    - name: Upload smoke test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: |
          test-results/
          playwright-report/
        retention-days: 7

  # Full test suite - comprehensive validation
  full-tests:
    name: Full Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: smoke-tests

    strategy:
      fail-fast: false
      matrix:
        project:
          - chromium-desktop
          - firefox-desktop
          - webkit-desktop
          - mobile-chrome
          - tablet-chrome

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Playwright browsers
      run: |
        npm run test:install
        npm run test:install-deps

    - name: Build application
      run: npm run build

    - name: Run Playwright tests
      run: npx playwright test --project=${{ matrix.project }}
      env:
        CI: true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.project }}
        path: |
          test-results/
          playwright-report/
        retention-days: 30

  # Visual regression tests
  visual-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: smoke-tests

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Playwright
      run: |
        npm run test:install
        npm run test:install-deps

    - name: Build application
      run: npm run build

    - name: Run visual regression tests
      run: npm run test:visual
      env:
        CI: true

    - name: Upload visual test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: visual-test-results
        path: |
          test-results/
          playwright-report/
        retention-days: 30

  # Performance tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: smoke-tests

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Playwright
      run: |
        npm run test:install
        npm run test:install-deps

    - name: Build application
      run: npm run build

    - name: Run performance tests
      run: npm run test:performance
      env:
        CI: true

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: |
          test-results/
          playwright-report/
        retention-days: 30

  # Mobile responsiveness tests
  mobile-tests:
    name: Mobile Responsiveness Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: smoke-tests

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Playwright
      run: |
        npm run test:install
        npm run test:install-deps

    - name: Build application
      run: npm run build

    - name: Run mobile responsiveness tests
      run: npm run test:mobile-responsive
      env:
        CI: true

    - name: Upload mobile test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mobile-test-results
        path: |
          test-results/
          playwright-report/
        retention-days: 30

  # Generate consolidated test report
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [full-tests, visual-tests, performance-tests, mobile-tests]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./test-artifacts

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate consolidated report
      run: |
        mkdir -p consolidated-report

        # Copy all test results
        find ./test-artifacts -name "*.json" -exec cp {} consolidated-report/ \;
        find ./test-artifacts -name "*.xml" -exec cp {} consolidated-report/ \;

        # Generate summary
        echo "# Edge.dev Playwright Test Summary" > consolidated-report/README.md
        echo "" >> consolidated-report/README.md
        echo "Generated: $(date)" >> consolidated-report/README.md
        echo "Commit: ${{ github.sha }}" >> consolidated-report/README.md
        echo "Branch: ${{ github.ref_name }}" >> consolidated-report/README.md
        echo "" >> consolidated-report/README.md

        # List test artifacts
        echo "## Test Artifacts" >> consolidated-report/README.md
        ls -la ./test-artifacts >> consolidated-report/README.md

    - name: Upload consolidated report
      uses: actions/upload-artifact@v4
      with:
        name: consolidated-test-report
        path: consolidated-report/
        retention-days: 90

    - name: Publish test results to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./test-artifacts/test-results-chromium-desktop/html-report
        destination_dir: test-reports/${{ github.run_number }}

  # Quality gates
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [full-tests, visual-tests, performance-tests, mobile-tests]
    if: always()

    steps:
    - name: Evaluate test results
      run: |
        echo "Evaluating test results for quality gates..."

        # Check if any jobs failed
        if [[ "${{ needs.full-tests.result }}" == "failure" ]]; then
          echo "❌ Full tests failed"
          exit 1
        fi

        if [[ "${{ needs.visual-tests.result }}" == "failure" ]]; then
          echo "❌ Visual tests failed"
          exit 1
        fi

        if [[ "${{ needs.performance-tests.result }}" == "failure" ]]; then
          echo "❌ Performance tests failed"
          exit 1
        fi

        if [[ "${{ needs.mobile-tests.result }}" == "failure" ]]; then
          echo "❌ Mobile tests failed"
          exit 1
        fi

        echo "✅ All quality gates passed"

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const results = {
            full: '${{ needs.full-tests.result }}',
            visual: '${{ needs.visual-tests.result }}',
            performance: '${{ needs.performance-tests.result }}',
            mobile: '${{ needs.mobile-tests.result }}'
          };

          const passed = Object.values(results).every(r => r === 'success');
          const emoji = passed ? '✅' : '❌';

          const body = `${emoji} **Edge.dev Playwright Test Results**

          | Test Suite | Status |
          |------------|--------|
          | Full Tests | ${results.full === 'success' ? '✅' : '❌'} ${results.full} |
          | Visual Tests | ${results.visual === 'success' ? '✅' : '❌'} ${results.visual} |
          | Performance Tests | ${results.performance === 'success' ? '✅' : '❌'} ${results.performance} |
          | Mobile Tests | ${results.mobile === 'success' ? '✅' : '❌'} ${results.mobile} |

          **Overall Status:** ${passed ? 'PASSED' : 'FAILED'}

          [View detailed results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

# Notifications
  notify-on-failure:
    name: Notify on Test Failure
    runs-on: ubuntu-latest
    needs: [quality-gates]
    if: failure() && github.ref == 'refs/heads/main'

    steps:
    - name: Send notification
      run: |
        echo "Tests failed on main branch - notifications would be sent here"
        # Integration with Slack, Teams, email, etc. would go here