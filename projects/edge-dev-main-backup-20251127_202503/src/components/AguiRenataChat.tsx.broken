'use client'

/**
 * AG-UI Enhanced Renata Chat - Scanner & Backtesting Specialist
 * Adapted for Edge-dev scanning and backtesting optimization
 * Uses Traderra styling with specialized scanning/backtesting terminology
 * Enhanced with code formatting integration
 */

import React, { useState, useEffect, useRef } from 'react'
import { Brain, Settings, AlertCircle, Sparkles, Send, RotateCcw, Code, Download, Copy, Upload, Maximize2, Minimize2, FileText, Paperclip, X } from 'lucide-react'
// import { UploadthingStyleDropzone } from './UploadthingStyleDropzone'
// import { useUploadthingForRenata } from '../hooks/useUploadthingForRenata'

type RenataMode = 'renata' | 'analyst' | 'coach' | 'mentor'

interface AttachedFile {
  id: string
  name: string
  size: number
  content: string
  type: string
}

interface ChatMessage {
  id: string
  type: 'user' | 'assistant' | 'error' | 'code-result'
  content: string
  timestamp: Date
  attachments?: AttachedFile[]
  data?: {
    formattedCode?: string
    stats?: {
      originalLines: number
      formattedLines: number
      scannerType: string
      parameterCount: number
      optimizations: string[]
    }
    downloadable?: boolean
  }
}

const RENATA_MODES = [
  {
    id: 'renata' as RenataMode,
    name: 'Renata',
    description: 'Scanning & Backtesting specialist',
    color: 'text-studio-gold',
    borderColor: 'border-studio-border',
  },
  {
    id: 'analyst' as RenataMode,
    name: 'Analyst',
    description: 'Scanner optimization expert',
    color: 'text-studio-gold',
    borderColor: 'border-studio-border',
  },
  {
    id: 'coach' as RenataMode,
    name: 'Coach',
    description: 'Backtesting strategy guide',
    color: 'text-studio-gold',
    borderColor: 'border-studio-border',
  },
  {
    id: 'mentor' as RenataMode,
    name: 'Mentor',
    description: 'Pattern recognition insights',
    color: 'text-studio-gold',
    borderColor: 'border-studio-border',
  },
]

function cn(...classes: string[]) {
  return classes.filter(Boolean).join(' ')
}

export function AguiRenataChat() {
  const [currentMode, setCurrentMode] = useState<RenataMode>('renata')
  const [messages, setMessages] = useState<ChatMessage[]>([])
  const [message, setMessage] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [connectionStatus, setConnectionStatus] = useState<'connected' | 'connecting' | 'disconnected'>('connected')
  const [activityStatus, setActivityStatus] = useState<'idle' | 'thinking' | 'processing'>('idle')
  const [isExpanded, setIsExpanded] = useState(false)
  const [isDragOver, setIsDragOver] = useState(false)
  const [attachedFiles, setAttachedFiles] = useState<AttachedFile[]>([])

  const messagesEndRef = useRef<HTMLDivElement>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)
  const chatFileInputRef = useRef<HTMLInputElement>(null)

  // Uploadthing integration - temporarily disabled
  // const { uploadFileForChat, isUploading: uploadthingUploading } = useUploadthingForRenata()
  const uploadFileForChat = null
  const uploadthingUploading = false

  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  // Add initial welcome message
  useEffect(() => {
    if (messages.length === 0) {
      setMessages([{
        id: 'welcome',
        type: 'assistant',
        content: 'Hello! I\'m Renata, your AI scanning and backtesting specialist. I can help you optimize scanners, develop backtesting strategies, and analyze pattern performance. What scanning or backtesting challenge can I help you with today?',
        timestamp: new Date()
      }])
    }
  }, [messages.length])

  // Simple drag overlay state for visual feedback with debugging
  useEffect(() => {
    const preventDefaultAndLog = (e: DragEvent) => {
      console.log('üåç DOCUMENT LEVEL:', e.type, 'event detected')
      e.preventDefault()
      e.stopPropagation()
    }

    // Add more comprehensive document-level event listeners
    const handleDocumentDragEnter = (e: DragEvent) => {
      console.log('üåç DOCUMENT DRAG ENTER:', e.target)
      e.preventDefault()
      e.stopPropagation()
    }

    const handleDocumentDragOver = (e: DragEvent) => {
      console.log('üåç DOCUMENT DRAG OVER:', e.target)
      e.preventDefault()
      e.stopPropagation()
    }

    const handleDocumentDrop = (e: DragEvent) => {
      console.log('üåç DOCUMENT DROP:', e.target)
      e.preventDefault()
      e.stopPropagation()
    }

    // Add document-level event listeners to prevent browser default behavior
    document.addEventListener('dragenter', handleDocumentDragEnter)
    document.addEventListener('dragover', handleDocumentDragOver)
    document.addEventListener('drop', handleDocumentDrop)

    return () => {
      document.removeEventListener('dragenter', handleDocumentDragEnter)
      document.removeEventListener('dragover', handleDocumentDragOver)
      document.removeEventListener('drop', handleDocumentDrop)
    }
  }, [])

  // Process chat requests through Renata API
  const processRenataRequest = async (messageContent: string): Promise<{content: string, data?: any, type?: string}> => {
    setActivityStatus('processing')

    try {
      const response = await fetch('/api/renata/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: messageContent,
          personality: currentMode,
          systemPrompt: `You are Renata, an AI trading assistant specialized in ${currentMode} mode.`,
          context: {
            page: 'edge-dev-dashboard',
            timestamp: new Date().toISOString(),
            mode: currentMode
          }
        })
      })

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`)
      }

      const result = await response.json()
      setActivityStatus('idle')

      // Handle code result responses
      if (result.type === 'code-result') {
        return {
          content: result.message,
          data: result.data,
          type: 'code-result'
        }
      }

      // Handle regular responses
      return {
        content: result.message || "I'm here to help with your trading needs!"
      }

    } catch (error) {
      console.error('Renata API error:', error)
      setActivityStatus('idle')
      throw new Error(`Failed to get response from Renata: ${error instanceof Error ? error.message : 'Unknown error'}`)
    }
  }

  // Send message function
  const handleSendMessage = async () => {
    if ((!message.trim() && attachedFiles.length === 0) || isLoading) return

    const messageContent = message.trim()
    const currentAttachments = [...attachedFiles]

    // Create message content with attachments
    let fullMessageContent = messageContent
    if (currentAttachments.length > 0) {
      fullMessageContent += currentAttachments.map(file =>
        `\n\n**Attached file: ${file.name}**\n\`\`\`${file.name.endsWith('.py') ? 'python' : 'text'}\n${file.content}\n\`\`\``
      ).join('')
    }

    // Add user message
    const newUserMessage: ChatMessage = {
      id: `user_${Date.now()}`,
      type: 'user',
      content: messageContent || (attachedFiles.length > 0 ? `üìé Attached ${attachedFiles.length} file(s)` : ''),
      timestamp: new Date(),
      attachments: currentAttachments.length > 0 ? currentAttachments : undefined
    }

    setMessages(prev => [...prev, newUserMessage])
    setMessage('')
    setAttachedFiles([])
    setIsLoading(true)
    setActivityStatus('thinking')

    try {
      // Process request through Renata API with file content
      const response = await processRenataRequest(fullMessageContent)

      // Add response message with appropriate type
      const responseMessage: ChatMessage = {
        id: `assistant_${Date.now()}`,
        type: response.type === 'code-result' ? 'code-result' : 'assistant',
        content: response.content,
        timestamp: new Date(),
        data: response.data
      }

      setMessages(prev => [...prev, responseMessage])
    } catch (error) {
      console.error('Failed to process message:', error)
      const errorMessage: ChatMessage = {
        id: `error_${Date.now()}`,
        type: 'error',
        content: `Sorry, I encountered an error: ${error instanceof Error ? error.message : 'Unknown error'}`,
        timestamp: new Date()
      }
      setMessages(prev => [...prev, errorMessage])
    } finally {
      setIsLoading(false)
    }
  }

  // Handle keyboard events
  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSendMessage()
    }

    // Cmd/Ctrl + Up Arrow to expand
    if ((e.metaKey || e.ctrlKey) && e.key === 'ArrowUp') {
      e.preventDefault()
      setIsExpanded(true)
    }

    // Escape to collapse
    if (e.key === 'Escape' && isExpanded) {
      e.preventDefault()
      setIsExpanded(false)
    }
  }

  // Handle chat reset
  const handleResetChat = () => {
    setMessages([{
      id: 'reset',
      type: 'assistant',
      content: 'üîÑ Chat reset successfully! How can I help you today?',
      timestamp: new Date()
    }])
    setMessage('')
    setIsLoading(false)
    setActivityStatus('idle')
    setConnectionStatus('connected')
  }

  // Copy code to clipboard
  const handleCopyCode = async (code: string) => {
    try {
      await navigator.clipboard.writeText(code)
      // Could add a toast notification here
    } catch (error) {
      console.error('Failed to copy code:', error)
    }
  }

  // Download code as file
  const handleDownloadCode = (code: string, filename: string = 'formatted_scanner.py') => {
    const blob = new Blob([code], { type: 'text/plain' })
    const url = URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = filename
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    URL.revokeObjectURL(url)
  }

  // Handle file upload
  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file) {
      processFile(file)
    }
  }

  // Process file from either upload or drag & drop
  const processFile = (file: File) => {
    if (file && (file.type === 'text/plain' || file.name.endsWith('.py') || file.name.endsWith('.txt'))) {
      const reader = new FileReader()
      reader.onload = (e) => {
        const content = e.target?.result as string
        setMessage(`Here's my Python scanner file (${file.name}):\n\n\`\`\`python\n${content}\n\`\`\``)
        setIsExpanded(true)
      }
      reader.readAsText(file)
    } else {
      alert('Please upload a Python (.py) file or text file.')
    }
  }

  // Attach file to chat (separate from processFile for direct message inclusion)
  const attachFile = (file: File) => {
    if (file && (file.type === 'text/plain' || file.name.endsWith('.py') || file.name.endsWith('.txt'))) {
      const reader = new FileReader()
      reader.onload = (e) => {
        const content = e.target?.result as string
        const attachedFile: AttachedFile = {
          id: Date.now().toString(),
          name: file.name,
          size: file.size,
          content: content,
          type: file.type || 'text/plain'
        }
        setAttachedFiles(prev => [...prev, attachedFile])
        setIsExpanded(true)
      }
      reader.readAsText(file)
    } else {
      alert('Please upload a Python (.py) file or text file.')
    }
  }

  // Handle chat file attachment
  const handleChatFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file) {
      attachFile(file)
    }
    // Reset input value to allow re-uploading same file
    if (event.target) {
      event.target.value = ''
    }
  }

  // Remove attached file
  const removeAttachedFile = (fileId: string) => {
    setAttachedFiles(prev => prev.filter(f => f.id !== fileId))
  }

  // Handle file drop from Uploadthing dropzone
  const handleUploadthingFileDrop = async (file: File) => {
    try {
      // For now, we'll handle files locally like the existing attachment system
      // Later we can integrate with actual Uploadthing upload if needed
      attachFile(file)
    } catch (error) {
      console.error('Failed to process dropped file:', error)
      alert(`Failed to process file: ${error instanceof Error ? error.message : 'Unknown error'}`)
    }
  }


  // Toggle expanded input area
  const toggleExpanded = () => {
    setIsExpanded(!isExpanded)
  }

  const currentModeInfo = RENATA_MODES.find(mode => mode.id === currentMode) || RENATA_MODES[0]

  return (
    <div
      className={cn(
        "flex flex-col",
        isDragOver && "bg-studio-gold/10"
      )}
      style={{
        position: 'fixed',
        top: '0',
        right: '0',
        height: '100vh',
        width: '30rem',
        zIndex: 30,
        backgroundColor: 'var(--studio-bg)',
        borderLeft: '1px solid var(--studio-gold)',
        backdropFilter: 'blur(10px)',
        boxShadow: 'var(--shadow-studio-lg)',
        display: 'flex',
        flexDirection: 'column'
      }}
      onDragEnter={(e) => {
        console.log('üü° DRAG ENTER detected on main container')
        e.preventDefault()
        e.stopPropagation()
        setIsDragOver(true)
      }}
      onDragOver={(e) => {
        console.log('üü¢ DRAG OVER detected on main container')
        e.preventDefault()
        e.stopPropagation()
        setIsDragOver(true)
      }}
      onDragLeave={(e) => {
        console.log('üü† DRAG LEAVE detected on main container')
        e.preventDefault()
        e.stopPropagation()
        // Only hide if we're leaving the entire component
        if (!e.currentTarget.contains(e.relatedTarget as Node)) {
          console.log('üî¥ Actually leaving main container - hiding overlay')
          setIsDragOver(false)
        }
      }}
      onDrop={(e) => {
        console.log('üéØ DROP detected on main container')
        e.preventDefault()
        e.stopPropagation()
        setIsDragOver(false)

        const files = Array.from(e.dataTransfer.files)
        console.log('üìÅ Files dropped:', files.length, files.map(f => f.name))
        if (files.length > 0) {
          const file = files[0]
          handleUploadthingFileDrop(file)
        }
      }}
    >
      {/* Fixed Header */}
      <div className="flex-shrink-0 flex items-center justify-between border-b px-6 py-4"
           style={{
             borderColor: 'var(--studio-border)',
             backgroundColor: 'var(--studio-surface)'
           }}>
        <div className="flex items-center space-x-3">
          <div className="flex h-10 w-10 items-center justify-center rounded-full" style={{ backgroundColor: 'rgba(212, 175, 55, 0.1)' }}>
            <Brain className="h-5 w-5" style={{ color: 'var(--studio-gold)' }} />
          </div>
          <div>
            <h3 className="font-semibold" style={{ color: 'var(--studio-text)' }}>Renata AI</h3>
            <p className="text-xs" style={{ color: 'var(--studio-muted)' }}>Trading Assistant</p>
          </div>
        </div>

        {/* Mode Selector */}
        <div className="flex items-center space-x-2">
          <select
            value={currentMode}
            onChange={(e) => setCurrentMode(e.target.value as RenataMode)}
            className="rounded border px-3 py-1 text-sm"
            style={{
              borderColor: 'var(--studio-border)',
              backgroundColor: 'var(--studio-surface)',
              color: 'var(--studio-text)'
            }}
          >
            {RENATA_MODES.map(mode => (
              <option key={mode.id} value={mode.id}>
                {mode.name}
              </option>
            ))}
          </select>
        </div>
      </div>

      {/* Fixed Status Bar */}
      <div className="flex-shrink-0 border-b px-6 py-3"
           style={{
             borderColor: 'var(--studio-border)',
             backgroundColor: 'rgba(17, 17, 17, 0.3)'
           }}>
        <div className="flex items-center justify-between text-xs" style={{ color: 'var(--studio-muted)' }}>
          <div className="flex items-center space-x-4">
            <span className={cn("flex items-center space-x-1", currentModeInfo.color)}>
              <Sparkles className="h-3 w-3" />
              <span>{currentModeInfo.name} Mode</span>
            </span>
          </div>
          <div className="flex items-center space-x-3">
            {/* Connection Status */}
            <div className={cn(
              "flex items-center space-x-1",
              connectionStatus === 'connected' ? 'text-green-400' :
              connectionStatus === 'connecting' ? 'text-yellow-400' : 'text-red-400'
            )}>
              <div className={cn(
                "h-2 w-2 rounded-full",
                connectionStatus === 'connected' ? 'bg-green-400' :
                connectionStatus === 'connecting' ? 'bg-yellow-400' : 'bg-red-400'
              )}></div>
              <span className="capitalize">{connectionStatus}</span>
            </div>

            {/* Reset Button */}
            <button
              onClick={handleResetChat}
              className="p-1 rounded-md transition-colors cursor-pointer"
              style={{
                backgroundColor: 'var(--studio-surface)',
                color: 'var(--studio-muted)'
              }}
              onMouseOver={(e) => e.currentTarget.style.backgroundColor = 'var(--studio-border)'}
              onMouseOut={(e) => e.currentTarget.style.backgroundColor = 'var(--studio-surface)'}
              title="Reset chat (clears errors and starts fresh)"
            >
              <RotateCcw className="h-3 w-3" />
            </button>
          </div>
        </div>
      </div>

      {/* Scrollable Chat Messages Area */}
      <div
        className="overflow-y-auto px-6 py-4 space-y-3"
        style={{
          flex: 1,
          minHeight: 0,
          paddingBottom: '1rem'
        }}
      >
        {messages.length === 0 ? (
          <div className="text-center py-8" style={{ color: 'var(--studio-muted)' }}>
            <Brain className="h-12 w-12 mx-auto mb-4" style={{ color: 'var(--studio-gold)' }} />
            <p className="text-sm">Ask me anything about trading, scanning, or market analysis...</p>
            <p className="text-xs mt-2">Try: "Help me optimize my scanner" ‚Ä¢ "Analyze this chart pattern" ‚Ä¢ "What are good risk management practices?"</p>
          </div>
        ) : (
          messages.map((msg) => (
            <div
              key={msg.id}
              className={cn(
                "flex w-full",
                msg.type === 'user' ? 'justify-end' : 'justify-start'
              )}
            >
              <div
                className={cn(
                  "max-w-[85%] rounded-lg px-4 py-3 text-sm shadow-sm",
                  msg.type === 'user'
                    ? 'border'
                    : msg.type === 'error'
                    ? 'bg-red-500/10 text-red-400 border border-red-500/20'
                    : 'border'
                )}
                style={{
                  backgroundColor: msg.type === 'user' ? 'var(--studio-gold)' : 'var(--studio-surface)',
                  color: msg.type === 'user' ? '#000000' : 'var(--studio-text)',
                  borderColor: msg.type === 'error' ? undefined : 'var(--studio-border)'
                }}
              >
                {/* Message Content */}
                <div className="whitespace-pre-wrap">{msg.content}</div>

                {/* Attached Files Display */}
                {msg.attachments && msg.attachments.length > 0 && (
                  <div className="mt-2 space-y-1">
                    {msg.attachments.map(file => (
                      <div
                        key={file.id}
                        className="flex items-center space-x-2 p-2 rounded border"
                        style={{
                          backgroundColor: 'rgba(255, 255, 255, 0.05)',
                          borderColor: 'var(--studio-border)',
                        }}
                      >
                        <FileText className="h-3 w-3 flex-shrink-0" style={{ color: 'var(--studio-muted)' }} />
                        <div className="flex-1 min-w-0">
                          <div className="text-xs truncate" style={{ color: msg.type === 'user' ? '#333' : 'var(--studio-text)' }}>
                            {file.name}
                          </div>
                          <div className="text-xs" style={{ color: msg.type === 'user' ? '#666' : 'var(--studio-muted)' }}>
                            {(file.size / 1024).toFixed(1)} KB
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {/* Code Result Display */}
                {msg.type === 'code-result' && msg.data?.formattedCode && (
                  <div className="mt-3 border rounded-lg overflow-hidden"
                       style={{ borderColor: 'var(--studio-border)' }}>
                    {/* Code Stats */}
                    {msg.data.stats && (
                      <div className="px-3 py-2 border-b flex items-center justify-between text-xs"
                           style={{
                             borderColor: 'var(--studio-border)',
                             backgroundColor: 'rgba(17, 17, 17, 0.5)',
                             color: 'var(--studio-muted)'
                           }}>
                        <div className="flex items-center space-x-4">
                          <span>Type: {msg.data.stats.scannerType}</span>
                          <span>Lines: {msg.data.stats.originalLines} ‚Üí {msg.data.stats.formattedLines}</span>
                          <span>Parameters: {msg.data.stats.parameterCount}</span>
                        </div>
                        <div className="flex items-center space-x-1">
                          <Code className="h-3 w-3" />
                          <span>Formatted Code</span>
                        </div>
                      </div>
                    )}

                    {/* Code Display */}
                    <div className="relative">
                      <pre className="p-3 text-xs overflow-x-auto font-mono"
                           style={{
                             backgroundColor: 'rgba(0, 0, 0, 0.3)',
                             color: 'var(--studio-text)'
                           }}>
                        <code>{msg.data.formattedCode}</code>
                      </pre>

                      {/* Action Buttons */}
                      <div className="absolute top-2 right-2 flex items-center space-x-1">
                        <button
                          onClick={() => handleCopyCode(msg.data!.formattedCode!)}
                          className="p-1.5 rounded bg-black/50 hover:bg-black/70 transition-colors"
                          title="Copy to clipboard"
                        >
                          <Copy className="h-3 w-3" style={{ color: 'var(--studio-muted)' }} />
                        </button>
                        {msg.data.downloadable && (
                          <button
                            onClick={() => handleDownloadCode(msg.data!.formattedCode!, 'formatted_scanner.py')}
                            className="p-1.5 rounded bg-black/50 hover:bg-black/70 transition-colors"
                            title="Download as file"
                          >
                            <Download className="h-3 w-3" style={{ color: 'var(--studio-muted)' }} />
                          </button>
                        )}
                      </div>
                    </div>

                    {/* Optimizations Applied */}
                    {msg.data.stats?.optimizations && msg.data.stats.optimizations.length > 0 && (
                      <div className="px-3 py-2 border-t text-xs"
                           style={{
                             borderColor: 'var(--studio-border)',
                             backgroundColor: 'rgba(17, 17, 17, 0.3)',
                             color: 'var(--studio-muted)'
                           }}>
                        <div className="font-medium mb-1">Optimizations Applied:</div>
                        <div className="space-y-1">
                          {msg.data.stats.optimizations.map((opt, idx) => (
                            <div key={idx} className="flex items-center space-x-1">
                              <div className="w-1 h-1 rounded-full bg-green-400"></div>
                              <span>{opt}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Timestamp */}
                <div className="text-xs mt-1 opacity-70"
                     style={{
                       color: msg.type === 'user' ? 'rgba(0, 0, 0, 0.7)' : 'var(--studio-muted)'
                     }}>
                  {msg.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
              </div>
            </div>
          ))
        )}
        {isLoading && (
          <div className="flex justify-start">
            <div className="border rounded-lg px-4 py-3 text-sm shadow-sm"
                 style={{
                   backgroundColor: 'var(--studio-surface)',
                   borderColor: 'var(--studio-border)'
                 }}>
              <div className="flex items-center space-x-3">
                <div className="flex space-x-1">
                  <div className="w-2 h-2 rounded-full animate-bounce" style={{ backgroundColor: 'var(--studio-gold)' }}></div>
                  <div className="w-2 h-2 rounded-full animate-bounce" style={{ backgroundColor: 'var(--studio-gold)', animationDelay: '0.1s' }}></div>
                  <div className="w-2 h-2 rounded-full animate-bounce" style={{ backgroundColor: 'var(--studio-gold)', animationDelay: '0.2s' }}></div>
                </div>
                <span style={{ color: 'var(--studio-text)' }}>Thinking...</span>
              </div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* Enhanced Input Area */}
      <div
        className="flex-shrink-0 border-t"
        style={{
          borderColor: 'var(--studio-border)',
          backgroundColor: 'var(--studio-surface)',
          padding: '0.75rem 1.5rem',
          flexShrink: 0
        }}
      >
        <div className="flex flex-col" style={{ gap: '0.75rem' }}>
          {/* Input Controls */}
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-2">
              {/* File Upload */}
              <input
                ref={fileInputRef}
                type="file"
                accept=".py,.txt"
                onChange={handleFileUpload}
                className="hidden"
              />
              <button
                onClick={() => fileInputRef.current?.click()}
                className="p-2 rounded-lg bg-[var(--studio-surface)] text-[var(--studio-muted)] hover:bg-[var(--studio-border)] transition-colors"
                title="Upload Python file"
              >
                <Upload className="h-4 w-4" />
              </button>

              {/* Expand/Collapse */}
              <button
                onClick={toggleExpanded}
                className="p-2 rounded-lg bg-[var(--studio-surface)] text-[var(--studio-muted)] hover:bg-[var(--studio-border)] transition-colors"
                title={isExpanded ? "Collapse input" : "Expand for code"}
              >
                {isExpanded ? <Minimize2 className="h-4 w-4" /> : <Maximize2 className="h-4 w-4" />}
              </button>
            </div>

            <div className="text-xs text-[var(--studio-muted)]">
              {message.length > 0 && `${message.length} chars`}
            </div>
          </div>

          {/* Attached Files Display */}
          {attachedFiles.length > 0 && (
            <div className="flex flex-col gap-3">
              <div className="text-xs font-medium text-[var(--studio-gold)]">
                üìé Attached files ({attachedFiles.length})
              </div>
              <div className="flex flex-col gap-2">
                {attachedFiles.map(file => (
                  <div
                    key={file.id}
                    className="flex items-center justify-between p-2 rounded-lg border border-[var(--studio-border)] bg-[var(--studio-surface)]"
                  >
                    <div className="flex items-center space-x-2 flex-1 min-w-0">
                      <FileText className="h-4 w-4 flex-shrink-0 text-[var(--studio-muted)]" />
                      <div className="flex-1 min-w-0">
                        <div className="text-sm truncate text-[var(--studio-text)]">
                          {file.name}
                        </div>
                        <div className="text-xs text-[var(--studio-muted)]">
                          {(file.size / 1024).toFixed(1)} KB
                        </div>
                      </div>
                    </div>
                    <button
                      onClick={() => removeAttachedFile(file.id)}
                      className="p-1 rounded hover:bg-black/20 transition-colors"
                      title="Remove file"
                    >
                      <X className="h-3 w-3 text-[var(--studio-muted)]" />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Input Area */}
          <div className="relative">
            <textarea
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              onKeyDown={handleKeyDown}
              disabled={isLoading}
              className={`w-full ${isExpanded ? 'h-64' : 'h-16'} resize-none rounded-lg border transition-all duration-300 disabled:opacity-50 focus:ring-1 focus:ring-opacity-30 font-mono text-sm`}
              style={{
                borderColor: 'var(--studio-border)',
                backgroundColor: 'var(--studio-surface)',
                color: 'var(--studio-text)',
                padding: '1rem',
                paddingRight: '5rem' // pr-20 equivalent
              }}
              placeholder={isExpanded
                ? "Paste your Python scanner code here or use /format command...\n\n# Example:\ndef my_scanner():\n    # Your trading logic here\n    pass"
                : "Ask me about trading, scanning, or market analysis..."
              }
            />

            {/* Chat File Input (Hidden) */}
            <input
              ref={chatFileInputRef}
              type="file"
              accept=".py,.txt"
              onChange={handleChatFileUpload}
              className="hidden"
            />

            {/* Action Buttons */}
            <div className="absolute bottom-3 right-3 flex items-center space-x-2">
              {/* File Attachment Button */}
              <button
                onClick={() => chatFileInputRef.current?.click()}
                className="p-1.5 rounded bg-[var(--studio-surface)] text-[var(--studio-muted)] hover:bg-[var(--studio-border)] transition-colors"
                title="Attach file to message"
              >
                <Paperclip className="h-3 w-3" />
              </button>

              {/* Quick Format Button */}
              {isExpanded && message.trim() && (
                <button
                  onClick={() => setMessage(`/format\n\n${message}`)}
                  className="p-1.5 rounded bg-[var(--studio-surface)] text-[var(--studio-gold)] hover:bg-[var(--studio-border)] transition-colors"
                  title="Add format command"
                >
                  <Code className="h-3 w-3" />
                </button>
              )}

              {/* Send Button */}
              <button
                type="button"
                onClick={handleSendMessage}
                disabled={(!message.trim() && attachedFiles.length === 0) || isLoading}
                className="btn-primary h-8 w-8 rounded-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <Send className="h-4 w-4" />
              </button>
            </div>
          </div>

          {/* Helper Text */}
          <div className="text-xs text-center text-[var(--studio-muted)]">
            <div className="flex items-center justify-center space-x-4">
              <span>üìÅ Upload .py files ‚Ä¢ Drag & drop supported</span>
              <span>üí¨ "/format" + code</span>
              <span>üîß Paste & ask for help</span>
            </div>
            <div className="mt-1">
              Press <kbd className="px-1 py-0.5 text-xs rounded bg-[var(--studio-surface)]">Enter</kbd> to send ‚Ä¢
              <kbd className="px-1 py-0.5 text-xs rounded bg-[var(--studio-surface)] ml-1">Shift + Enter</kbd> for new line ‚Ä¢
              <kbd className="px-1 py-0.5 text-xs rounded bg-[var(--studio-surface)] ml-1">‚åò + ‚Üë</kbd> expand
            </div>
          </div>
        </div>
      </div>

      {/* Drag & Drop Overlay */}
      {isDragOver && (
        <div className="absolute inset-0 border-2 border-dashed flex items-center justify-center z-50"
             style={{
               backgroundColor: 'rgba(212, 175, 55, 0.1)',
               borderColor: 'var(--studio-gold)'
             }}>
          <div className="text-center">
            <Upload className="h-12 w-12 mx-auto mb-4" style={{ color: 'var(--studio-gold)' }} />
            <h3 className="text-lg font-semibold mb-2" style={{ color: 'var(--studio-gold)' }}>Drop Python files here</h3>
            <p style={{ color: 'var(--studio-text)' }}>Release to upload .py or .txt files</p>
          </div>
        </div>
      )}
    </div>
  )
}