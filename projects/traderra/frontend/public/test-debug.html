<!DOCTYPE html>
<html>
<head>
    <title>File Upload Debug Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #e0e0e0; }
        h1 { color: #4ade80; }
        .section { background: #2a2a2a; padding: 15px; margin: 10px 0; border-radius: 8px; }
        button { background: #4ade80; color: #000; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        #output { background: #0a0a0a; padding: 15px; border-radius: 8px; white-space: pre-wrap; max-height: 600px; overflow-y: auto; }
        .success { color: #4ade80; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <h1>üîç File Upload Debug Test</h1>

    <div class="section">
        <button onclick="testDirectMessage()">Test 1: Direct Message (No File)</button>
        <button onclick="testWithFileMarker()">Test 2: Message with File Marker (Simulated)</button>
        <button onclick="testWithRealFile()">Test 3: Real File Upload</button>
        <button onclick="clearOutput()">Clear</button>
    </div>

    <h2>Output:</h2>
    <pre id="output"></pre>

    <script>
        function log(msg, type = 'info') {
            const output = document.getElementById('output');
            const prefix = { 'success': '‚úÖ ', 'error': '‚ùå ', 'warning': '‚ö†Ô∏è ' }[type] || '';
            output.textContent += `\n${prefix}${msg}`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
        }

        async function testDirectMessage() {
            clearOutput();
            log('Test 1: Sending direct message without file...', 'info');

            try {
                const response = await fetch('/api/agui', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Hello, can you hear me?',
                        userId: 'test-user',
                        concise: true
                    })
                });

                const data = await response.json();
                log('Response:', 'info');
                log(JSON.stringify(data, null, 2), 'info');
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function testWithFileMarker() {
            clearOutput();
            log('Test 2: Sending message with simulated file upload marker...', 'info');

            const messageWithFile = `Hello, I want to upload my trades.

[üìé FILE UPLOADED: test-trades.csv]
- Type: CSV file with 3 trade(s)
- Columns: Open Datetime, Close Datetime, Symbol, Side, Volume, Entry Price, Exit Price, Net P&L
- Status: File received successfully and ready for import`;

            try {
                const response = await fetch('/api/agui', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: messageWithFile,
                        userId: 'test-user',
                        concise: true
                    })
                });

                const data = await response.json();
                log('Response:', 'info');
                log(JSON.stringify(data, null, 2), 'info');

                if (data.response && data.response.includes('FILE UPLOADED')) {
                    log('SUCCESS: AI acknowledged the file upload!', 'success');
                } else {
                    log('FAIL: AI did not acknowledge the file upload', 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function testWithRealFile() {
            clearOutput();
            log('Test 3: Uploading real CSV file...', 'info');

            const testCSV = `Open Datetime,Close Datetime,Symbol,Side,Volume,Entry Price,Exit Price,Net P&L
2024-01-15 09:30:00,2024-01-15 10:15:00,AAPL,Long,100,150.25,152.30,205.0
2024-01-16 14:00:00,2024-01-16 14:30:00,TSLA,Short,50,210.50,208.25,112.5
2024-01-17 10:00:00,2024-01-17 11:00:00,MSFT,Long,75,380.00,385.50,412.5`;

            const base64Content = btoa(testCSV);

            try {
                const response = await fetch('/api/agui', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Upload my trades',
                        attachedFile: {
                            name: 'test-trades.csv',
                            content: base64Content
                        },
                        userId: 'test-user',
                        concise: true
                    })
                });

                const data = await response.json();
                log('Response:', 'info');
                log(JSON.stringify(data, null, 2), 'info');

                if (data.response && data.response.includes('FILE UPLOADED')) {
                    log('SUCCESS: AI acknowledged the file upload!', 'success');
                } else if (data.response && data.response.toLowerCase().includes('encoding')) {
                    log('WARNING: AI is talking about encoding errors - this means file info was NOT added to message', 'warning');
                } else {
                    log('FAIL: AI did not acknowledge the file upload', 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
